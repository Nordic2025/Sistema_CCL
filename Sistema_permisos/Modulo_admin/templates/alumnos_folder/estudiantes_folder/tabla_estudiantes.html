{% extends 'base_admin.html' %}

{% load static %}

{% block title %}Alumnos{% endblock %}

{% block content %}
<div class="container main-content">
    <h1 style="margin-top: 30px; font-size: 2rem;">Panel de Administrador | Alumnos</h1>  
    
<!-- Boton para avanzar de año -->
    {% if user.is_superuser %}
      <div class="d-flex mb-3">
        <button type="button" class="btn btn_general me-2" data-bs-toggle="modal" data-bs-target="#agregarAlumnoModal">
          Registrar nuevo alumno
        </button>
        <button type="button" class="btn btn-warning" id="btnPromocionAnual">
          <i class="fas fa-graduation-cap"></i> Pasar al Siguiente Año
        </button>
      </div>
    {% endif %}

    <!-- Modal para alerta de confirmacion avnzar al año siguiente --> 
    <div class="modal fade" id="promocionAnualModal" tabindex="-1" aria-labelledby="promocionAnualModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-warning">
            <h5 class="modal-title" id="promocionAnualModalLabel">
              <i class="fas fa-exclamation-triangle"></i> Confirmación de Promoción Anual
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-danger">
              <h4 class="alert-heading text-center">¡ATENCIÓN!</h4>
              <p class="text-center"><strong>Esta acción es IRREVERSIBLE</strong></p>
              <hr>
              <p>Está a punto de promover a todos los alumnos al siguiente año académico:</p>
              <ul>
                <li>Los alumnos avanzarán al siguiente nivel según el sistema educativo</li>
                <li>Los alumnos de 4° Medio serán enviados a la tabla "Egresados"</li>
                <li>Se mantendrán las mismas secciones (letras) por curso</li>
              </ul>
              <p>Los casos especiales (repitentes, traslados, etc.) deberán gestionarse manualmente después de este proceso.</p>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="confirmarPromocion">
              <label class="form-check-label" for="confirmarPromocion">
                Entiendo que esta acción no se puede deshacer
              </label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <form action="{% url 'Modulo_admin:promocion_anual' %}" method="POST" id="formPromocionAnual">
              {% csrf_token %}
              <button type="submit" class="btn btn-warning" id="btnConfirmarPromocion" disabled>
                Confirmar Promoción
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>


    <!-- Filtros combinados (buscador, curso y nivel) -->
    <div class="row mb-4 mt-4">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Filtros</h5>
          </div>
          <div class="card-body">
            <form id="filtroForm" method="get" action="{% url 'Modulo_admin:alumnos' %}" class="row g-3">
              <!-- Buscador -->
              <div class="col-md-4">
                <label for="busqueda" class="form-label">Buscar por nombre o RUT:</label>
                <input type="text" id="busqueda" name="busqueda" class="form-control" placeholder="Nombre o RUT"
                  value="{{ busqueda }}" autocomplete="off">
              </div>

              <!-- Filtro por curso -->
              <div class="col-md-3">
                <label for="curso" class="form-label">Curso:</label>
                <select class="form-select" id="curso" name="curso">
                  <option value="">Todos los cursos</option>
                  {% for curso in cursos %}
                  <option value="{{ curso.id }}" {% if curso_filtro == curso.id|stringformat:"s" %}selected{% endif %}>{{ curso.nombre }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-2 d-flex align-items-end">
                <div class="d-grid gap-2 w-100">
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search"></i> Buscar
                  </button>
                  {% if busqueda or curso_filtro or nivel_filtro %}
                  <a href="{% url 'Modulo_admin:alumnos' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-times"></i> Limpiar filtros
                  </a>
                  {% endif %}
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>


    <!-- Indicadores de filtros activos -->
    {% if busqueda or curso_filtro or nivel_filtro %}
    <div class="row mb-4">
      <div class="col-md-12">
        <div class="alert alert-info">
          <h5 class="alert-heading">Filtros activos:</h5>
          <ul class="mb-0">
            {% if busqueda %}
            <li>Búsqueda: <strong>{{ busqueda }}</strong></li>
            {% endif %}
            {% if curso_filtro %}
            <li>Curso: <strong>{{ curso_nombre }}</strong></li>
            {% endif %}
            </ul>
        </div>
      </div>
    </div>
    {% endif %}

    <div class="row">
      <div class="col-md-12">
        <div class="tabla_global">
          <table class="tabla_ancha">
            <thead class="thead_custom">
              <tr>
                <th>RUT</th>
                <th>Nombre</th>
                <th>Curso</th>
                <th>Apoderado Titular</th>
                <th>Rut Apoderado Titular</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody class="tbody_custom">
              {% for alumno in alumnos %}
              <tr>
                <td>{{ alumno.rut }}</td>
                <td>{{ alumno.nombre }}</td>
                <td>{{ alumno.curso }}</td>
                <td>{{ alumno.apoderado_titular }}</td>
                <td>{{ alumno.rut_apoderadoT }}</td>
                <td>
                  {% if user.is_superuser %}
                  <button type="button" class="btn btn_editar btn-outline-warning" 
                          data-bs-toggle="modal" 
                          data-bs-target="#editarAlumnoModal{{ alumno.id }}">
                    Editar
                  </button>
                  {% endif %}
                  <button type="button" class="btn btn_primary btn-outline-primary" 
                          data-bs-toggle="modal" 
                          data-bs-target="#verDetalleModal{{ alumno.id }}">
                    Ver Detalle
                  </button>
                  {% if user.is_superuser %}
                  <button type="button" class="btn btn_eliminar btn-outline-danger" 
                          onclick="confirmarEliminacion('{{ alumno.id }}', '{{ alumno.nombre }}')">
                    Eliminar
                  </button>
                  {% endif %}
                </td>
              </tr>
              
              {% if user.is_superuser %}
              <!-- Modal para Editar Alumno -->
              <div class="modal fade" id="editarAlumnoModal{{ alumno.id }}" tabindex="-1" aria-labelledby="editarAlumnoModalLabel{{ alumno.id }}" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                  <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                      <h5 class="modal-title" id="editarAlumnoModalLabel{{ alumno.id }}">Editar Alumno</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <form method="POST" action="{% url 'Modulo_admin:editar_alumno' alumno.id %}" class="alumnoForm">
                        {% csrf_token %}
                        
                        <!-- Información del Alumno -->
                        <div class="card mb-4">
                          <div class="card-header bg-light">
                            <h5 class="mb-0">Información del Alumno</h5>
                          </div>
                          <div class="card-body">
                            <div class="row g-3">
                              <div class="col-md-4">
                                <div class="form-group">
                                  <label for="rut{{ alumno.id }}" class="form-label">RUT</label>
                                  <input type="text" class="form-control rut-input" id="rut{{ alumno.id }}" name="rut" value="{{ alumno.rut|default:'' }}">
                                </div>
                              </div>
                              <div class="col-md-8">
                                <div class="form-group">
                                  <label for="nombre{{ alumno.id }}" class="form-label">Nombre Completo</label>
                                  <input type="text" class="form-control" id="nombre{{ alumno.id }}" name="nombre" value="{{ alumno.nombre|default:'' }}">
                                </div>
                              </div>
                              <div class="col-md-12">
                                <div class="form-group">
                                  <label for="curso{{ alumno.id }}" class="form-label">Curso</label>
                                  <select class="form-control" id="curso{{ alumno.id }}" name="curso">
                                    {% for curso in cursos %}
                                      <option value="{{ curso.id }}" {% if alumno.curso.id == curso.id %}selected{% endif %}>{{ curso.nombre }}</option>
                                    {% endfor %}
                                  </select>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        
                        <!-- Información de Apoderados -->
                        <div class="card mb-4">
                          <div class="card-header bg-light">
                            <h5 class="mb-0">Información de Apoderados</h5>
                          </div>
                          <div class="card-body">
                            <!-- Apoderado Titular -->
                            <div class="row g-3 mb-3">
                              <div class="col-12">
                                <h6 class="border-bottom pb-2">Apoderado Titular</h6>
                              </div>
                              <div class="col-md-6">
                                <div class="form-group">
                                  <label for="apoderado_titular{{ alumno.id }}" class="form-label">Nombre Completo</label>
                                  <input type="text" class="form-control" id="apoderado_titular{{ alumno.id }}" name="apoderado_titular" value="{{ alumno.apoderado_titular|default:'' }}">
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="form-group">
                                  <label for="rut_apoderadoT{{ alumno.id }}" class="form-label">RUT</label>
                                  <input type="text" class="form-control rut-input" id="rut_apoderadoT{{ alumno.id }}" name="rut_apoderadoT" value="{{ alumno.rut_apoderadoT|default:'' }}">
                                </div>
                              </div>
                              <div class="col-md-12">
                                <div class="form-group">
                                  <label for="telefono_apoderadoT{{ alumno.id }}" class="form-label">Teléfono</label>
                                  <div class="input-group">
                                    <span class="input-group-text">+56</span>
                                    <input type="text" class="form-control telefono-input" id="telefono_apoderadoT{{ alumno.id }}" name="telefono_apoderadoT" value="{{ alumno.telefono_apoderadoT|default:''|slice:'3:' }}" maxlength="9">
                                  </div>
                                  <small class="form-text text-muted">Ingrese los 9 dígitos, sin el prefijo +56</small>
                                </div>
                              </div>
                            </div>
                            
                            <!-- Apoderado Suplente -->
                            <div class="row g-3">
                              <div class="col-12">
                                <h6 class="border-bottom pb-2">Apoderado Suplente</h6>
                              </div>
                              <div class="col-md-6">
                                <div class="form-group">
                                  <label for="apoderado_suplente{{ alumno.id }}" class="form-label">Nombre Completo</label>
                                  <input type="text" class="form-control" id="apoderado_suplente{{ alumno.id }}" name="apoderado_suplente" value="{{ alumno.apoderado_suplente|default:'' }}">
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="form-group">
                                  <label for="rut_apoderadoS{{ alumno.id }}" class="form-label">RUT</label>
                                  <input type="text" class="form-control rut-input" id="rut_apoderadoS{{ alumno.id }}" name="rut_apoderadoS" value="{{ alumno.rut_apoderadoS|default:'' }}">
                                </div>
                              </div>
                              <div class="col-md-12">
                                <div class="form-group">
                                  <label for="telefono_apoderadoS{{ alumno.id }}" class="form-label">Teléfono</label>
                                  <div class="input-group">
                                    <span class="input-group-text">+56</span>
                                    <input type="text" class="form-control telefono-input" id="telefono_apoderadoS{{ alumno.id }}" name="telefono_apoderadoS" value="{{ alumno.telefono_apoderadoS|default:''|slice:'3:' }}" maxlength="9">
                                  </div>
                                  <small class="form-text text-muted">Ingrese los 9 dígitos, sin el prefijo +56</small>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        
                        <!-- Información de Familiares -->
                        <div class="row">
                          <!-- Familiar 1 -->
                          <div class="col-md-6">
                            <div class="card mb-4 h-100">
                              <div class="card-header bg-light">
                                <h5 class="mb-0">Familiar 1</h5>
                              </div>
                              <div class="card-body">
                                <div class="form-group mb-3">
                                  <label for="familiar_1{{ alumno.id }}" class="form-label">Nombre Completo</label>
                                  <input type="text" class="form-control" id="familiar_1{{ alumno.id }}" name="familiar_1" value="{{ alumno.familiar_1|default:'' }}">
                                </div>
                                <div class="form-group mb-3">
                                  <label for="rut_familiar_1{{ alumno.id }}" class="form-label">RUT</label>
                                  <input type="text" class="form-control rut-input" id="rut_familiar_1{{ alumno.id }}" name="rut_familiar_1" value="{{ alumno.rut_familiar_1|default:'' }}">
                                </div>
                                <div class="form-group mb-3">
                                  <label for="familiar_1_relacion{{ alumno.id }}" class="form-label">Relación</label>
                                  <input type="text" class="form-control" id="familiar_1_relacion{{ alumno.id }}" name="familiar_1_relacion" value="{{ alumno.familiar_1_relacion|default:'' }}">
                                </div>
                                <div class="form-group">
                                  <label for="familiar_1_telefono{{ alumno.id }}" class="form-label">Teléfono</label>
                                  <div class="input-group">
                                    <span class="input-group-text">+56</span>
                                    <input type="text" class="form-control telefono-input" id="familiar_1_telefono{{ alumno.id }}" name="familiar_1_telefono" value="{{ alumno.familiar_1_telefono|default:''|slice:'3:' }}" maxlength="9">
                                  </div>
                                  <small class="form-text text-muted">Ingrese los 9 dígitos, sin el prefijo +56</small>
                                </div>
                              </div>
                            </div>
                          </div>
                          
                          <!-- Familiar 2 -->
                          <div class="col-md-6">
                            <div class="card mb-4 h-100">
                              <div class="card-header bg-light">
                                <h5 class="mb-0">Familiar 2</h5>
                              </div>
                              <div class="card-body">
                                <div class="form-group mb-3">
                                  <label for="familiar_2{{ alumno.id }}" class="form-label">Nombre Completo</label>
                                  <input type="text" class="form-control" id="familiar_2{{ alumno.id }}" name="familiar_2" value="{{ alumno.familiar_2|default:'' }}">
                                </div>
                                <div class="form-group mb-3">
                                  <label for="rut_familiar_2{{ alumno.id }}" class="form-label">RUT</label>
                                  <input type="text" class="form-control rut-input" id="rut_familiar_2{{ alumno.id }}" name="rut_familiar_2" value="{{ alumno.rut_familiar_2|default:'' }}">
                                </div>
                                <div class="form-group mb-3">
                                  <label for="familiar_2_relacion{{ alumno.id }}" class="form-label">Relación</label>
                                  <input type="text" class="form-control" id="familiar_2_relacion{{ alumno.id }}" name="familiar_2_relacion" value="{{ alumno.familiar_2_relacion|default:'' }}">
                                </div>
                                <div class="form-group">
                                  <label for="familiar_2_telefono{{ alumno.id }}" class="form-label">Teléfono</label>
                                  <div class="input-group">
                                    <span class="input-group-text">+56</span>
                                    <input type="text" class="form-control telefono-input" id="familiar_2_telefono{{ alumno.id }}" name="familiar_2_telefono" value="{{ alumno.familiar_2_telefono|default:''|slice:'3:' }}" maxlength="9">
                                  </div>
                                  <small class="form-text text-muted">Ingrese los 9 dígitos, sin el prefijo +56</small>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        
                        <div class="d-flex justify-content-end mt-4">
                          <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancelar</button>
                          <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
              {% endif %}

              <!-- Modal para Ver Detalle -->
              <div class="modal fade" id="verDetalleModal{{ alumno.id }}" tabindex="-1" aria-labelledby="verDetalleModalLabel{{ alumno.id }}" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="verDetalleModalLabel{{ alumno.id }}">Detalles del Alumno | {{ alumno.nombre }}</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <div class="row">
                        <div class="col-md-6">
                          <div class="card mb-3">
                            <div class="card-body">
                              <h5 class="card-title">Información Personal</h5>
                              <p><strong>RUT:</strong> {{ alumno.rut }}</p>
                              <p><strong>Nombre Completo:</strong> {{ alumno.nombre }}</p>
                              <p><strong>Curso:</strong> {{ alumno.curso.nombre }}</p>
                            </div>
                          </div>
                          
                          <div class="card">
                            <div class="card-body">
                              <h5 class="card-title">Apoderados</h5>
                              <p><strong>Apoderado Titular:</strong> {{ alumno.apoderado_titular }}</p>
                              <p><strong>RUT Apoderado Titular:</strong> {{ alumno.rut_apoderadoT|default:"No registrado" }}</p>
                              <p><strong>Telefono Apoderado Titular:</strong> {{ alumno.telefono_apoderadoT|default:"No registrado" }}</p>
                              <p><strong>Apoderado Suplente:</strong> {{ alumno.apoderado_suplente|default:"No registrado" }}</p>
                              <p><strong>RUT Apoderado Suplente:</strong> {{ alumno.rut_apoderadoS|default:"No registrado" }}</p>
                              <p><strong>Telefono Apoderado Suplente:</strong> {{ alumno.telefono_apoderadoS|default:"No registrado" }}</p>
                            </div>
                          </div>
                        </div>
                        
                        <div class="col-md-6">
                          <h5 class="card-title mb-3">Familiares Adicionales</h5>
                          
                          {% if alumno.familiar_1 %}
                          <div class="card mb-3">
                            <div class="card-body">
                              <h6 class="card-subtitle mb-2 text-muted">Familiar 1</h6>
                              <p><strong>Nombre:</strong> {{ alumno.familiar_1 }}</p>
                              <p><strong>RUT:</strong> {{ alumno.rut_familiar_1|default:"No registrado" }}</p>
                              <p><strong>Relación:</strong> {{ alumno.familiar_1_relacion|default:"No especificada" }}</p>
                              <p><strong>Teléfono:</strong> {{ alumno.familiar_1_telefono|default:"No registrado" }}</p>
                            </div>
                          </div>
                          {% else %}
                          <div class="mb-3">
                          <button type="button" class="btn btn-sm btn-success nested-modal-btn" 
                            data-target-modal="#agregarFamiliar1Modal{{ alumno.id }}"
                            data-parent-modal="#verDetalleModal{{ alumno.id }}">
                              + Añadir Familiar 1
                          </button>
                          </div>
                          {% endif %}
                          
                          {% if alumno.familiar_2 %}
                          <div class="card">
                            <div class="card-body">
                              <h6 class="card-subtitle mb-2 text-muted">Familiar 2</h6>
                              <p><strong>Nombre:</strong> {{ alumno.familiar_2 }}</p>
                              <p><strong>RUT:</strong> {{ alumno.rut_familiar_2|default:"No registrado" }}</p>
                              <p><strong>Relación:</strong> {{ alumno.familiar_2_relacion|default:"No especificada" }}</p>
                              <p><strong>Teléfono:</strong> {{ alumno.familiar_2_telefono|default:"No registrado" }}</p>
                            </div>
                          </div>
                          {% elif alumno.familiar_1 %}
                            <div>
                              <button type="button" class="btn btn-sm btn-success nested-modal-btn" 
                                    data-target-modal="#agregarFamiliar2Modal{{ alumno.id }}"
                                    data-parent-modal="#verDetalleModal{{ alumno.id }}">
                                + Añadir Familiar 2
                              </button>
                            </div>
                            {% endif %}
                        </div>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Modal para Añadir Familiar 1 -->
              <div class="modal fade" id="agregarFamiliar1Modal{{ alumno.id }}" tabindex="-1" aria-labelledby="agregarFamiliar1ModalLabel{{ alumno.id }}" aria-hidden="true" data-bs-backdrop="static">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="agregarFamiliar1ModalLabel{{ alumno.id }}">Añadir Familiar 1 | {{ alumno.nombre }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form method="POST" action="{% url 'Modulo_admin:agregar_familiar' alumno.id 1 %}" class="familiarForm">
                                {% csrf_token %}
                            {% csrf_token %}
                            <div class="mb-3">
                              <label for="{{ familiar_form.familiar_nombre.id_for_label }}" class="form-label">Nombre del Familiar</label>
                              {{ familiar_form.familiar_nombre }}
                              {% if familiar_form.familiar_nombre.errors %}
                                <div class="text-danger">
                                  {% for error in familiar_form.familiar_nombre.errors %}
                                    {{ error }}
                                  {% endfor %}
                                </div>
                              {% endif %}
                            </div>
                            <div class="mb-3">
                              <label for="{{ familiar_form.familiar_rut.id_for_label }}" class="form-label">RUT del Familiar</label>
                              {{ familiar_form.familiar_rut }}
                              {% if familiar_form.familiar_rut.errors %}
                                <div class="text-danger">
                                  {% for error in familiar_form.familiar_rut.errors %}
                                    {{ error }}
                                  {% endfor %}
                                </div>
                              {% endif %}
                            </div>
                            <div class="mb-3">
                              <label for="{{ familiar_form.familiar_relacion.id_for_label }}" class="form-label">Relación con el Alumno</label>
                              {{ familiar_form.familiar_relacion }}
                              {% if familiar_form.familiar_relacion.errors %}
                                <div class="text-danger">
                                  {% for error in familiar_form.familiar_relacion.errors %}
                                    {{ error }}
                                  {% endfor %}
                                </div>
                              {% endif %}
                            </div>
                            <div class="mb-3">
                              <label for="{{ familiar_form.familiar_telefono.id_for_label }}" class="form-label">Teléfono de Contacto</label>
                              {{ familiar_form.familiar_telefono }}
                              {% if familiar_form.familiar_telefono.errors %}
                                <div class="text-danger">
                                  {% for error in familiar_form.familiar_telefono.errors %}
                                    {{ error }}
                                  {% endfor %}
                                </div>
                              {% endif %}
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                              <button type="submit" class="btn btn-success">Guardar Familiar</button>
                          </div>
                      </form>
                  </div>
              </div>
          </div>
      </div>

          <!-- Modal para Añadir Familiar 2 -->
          <div class="modal fade" id="agregarFamiliar2Modal{{ alumno.id }}" tabindex="-1" aria-labelledby="agregarFamiliar2ModalLabel{{ alumno.id }}" aria-hidden="true" data-bs-backdrop="static">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="agregarFamiliar2ModalLabel{{ alumno.id }}">Añadir Familiar 2 | {{ alumno.nombre }}</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <form method="POST" action="{% url 'Modulo_admin:agregar_familiar' alumno.id 2 %}" class="familiarForm">
                    {% csrf_token %}
                    <div class="mb-3">
                      <label for="{{ familiar_form.familiar_nombre.id_for_label }}" class="form-label">Nombre del Familiar</label>
                      <input type="text" class="form-control" id="{{ familiar_form.familiar_nombre.id_for_label }}" name="{{ familiar_form.familiar_nombre.html_name }}" value="{{ familiar_form.familiar_nombre.value|default:'' }}" placeholder="Nombre completo">
                      {% if familiar_form.familiar_nombre.errors %}
                        <div class="text-danger">
                          {% for error in familiar_form.familiar_nombre.errors %}
                            {{ error }}
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>
                    <div class="mb-3">
                      <label for="{{ familiar_form.familiar_rut.id_for_label }}" class="form-label">RUT del Familiar</label>
                      <input type="text" class="form-control rut-input" id="{{ familiar_form.familiar_rut.id_for_label }}" name="{{ familiar_form.familiar_rut.html_name }}" value="{{ familiar_form.familiar_rut.value|default:'' }}" placeholder="Ej: 12.345.678-9">
                      {% if familiar_form.familiar_rut.errors %}
                        <div class="text-danger">
                          {% for error in familiar_form.familiar_rut.errors %}
                            {{ error }}
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>
                    <div class="mb-3">
                      <label for="{{ familiar_form.familiar_relacion.id_for_label }}" class="form-label">Relación con el Alumno</label>
                      <input type="text" class="form-control" id="{{ familiar_form.familiar_relacion.id_for_label }}" name="{{ familiar_form.familiar_relacion.html_name }}" value="{{ familiar_form.familiar_relacion.value|default:'' }}" placeholder="Ej: Abuelo, Tío, etc.">
                      {% if familiar_form.familiar_relacion.errors %}
                        <div class="text-danger">
                          {% for error in familiar_form.familiar_relacion.errors %}
                            {{ error }}
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>
                    <div class="mb-3">
                      <label for="{{ familiar_form.familiar_telefono.id_for_label }}" class="form-label">Teléfono de Contacto</label>
                      <div class="input-group">
                        <span class="input-group-text">+56</span>
                        <input type="text" class="form-control telefono-input" id="{{ familiar_form.familiar_telefono.id_for_label }}" name="{{ familiar_form.familiar_telefono.html_name }}" value="{{ familiar_form.familiar_telefono.value|default:'' }}" maxlength="9" placeholder="912345678">
                      </div>
                      <small class="form-text text-muted">Ingrese los 9 dígitos, sin el prefijo +56</small>
                      {% if familiar_form.familiar_telefono.errors %}
                        <div class="text-danger">
                          {% for error in familiar_form.familiar_telefono.errors %}
                            {{ error }}
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                      <button type="submit" class="btn btn-success">Guardar Familiar</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
              {% empty %}
              <tr>
                <td colspan="9" class="text-center py-3">
                  <div class="alert alert-info mb-0">
                    No hay alumnos registrados para los criterios seleccionados.
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>


  
      {% if user.is_superuser %}
      <!-- Modal para Agregar Alumno -->
      <div class="modal fade" id="agregarAlumnoModal" tabindex="-1" aria-labelledby="agregarAlumnoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title" id="agregarAlumnoModalLabel">Registrar nuevo Alumno</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form method="POST" action="{% url 'Modulo_admin:agregar_alumno' %}" class="alumnoForm">
                {% csrf_token %}
                
                <!-- Información del Alumno -->
                <div class="card mb-4">
                  <div class="card-header bg-light">
                    <h5 class="mb-0">Información del Alumno</h5>
                  </div>
                  <div class="card-body">
                    <div class="row g-3">
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="{{ form.rut.id_for_label }}" class="form-label">RUT</label>
                          <input type="text" class="form-control rut-input" id="{{ form.rut.id_for_label }}" name="{{ form.rut.html_name }}" value="{{ form.rut.value|default:'' }}" placeholder="Ej: 12.345.678-9">
                          {% if form.rut.errors %}
                            <div class="text-danger">
                              {% for error in form.rut.errors %}
                                {{ error }}
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                      <div class="col-md-8">
                        <div class="form-group">
                          <label for="{{ form.nombre.id_for_label }}" class="form-label">Nombre Completo</label>
                          <input type="text" class="form-control" id="{{ form.nombre.id_for_label }}" name="{{ form.nombre.html_name }}" value="{{ form.nombre.value|default:'' }}" placeholder="Nombre completo del alumno">
                          {% if form.nombre.errors %}
                            <div class="text-danger">
                              {% for error in form.nombre.errors %}
                                {{ error }}
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                      <div class="col-md-12">
                        <div class="form-group">
                          <label for="{{ form.curso.id_for_label }}" class="form-label">Curso</label>
                          <select class="form-control" id="{{ form.curso.id_for_label }}" name="{{ form.curso.html_name }}">
                            <option value="">Seleccione un curso</option>
                            {% for curso in cursos %}
                              <option value="{{ curso.id }}" {% if form.curso.value == curso.id %}selected{% endif %}>{{ curso.nombre }}</option>
                            {% endfor %}
                          </select>
                          {% if form.curso.errors %}
                            <div class="text-danger">
                              {% for error in form.curso.errors %}
                                {{ error }}
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Información de Apoderados -->
                <div class="card mb-4">
                  <div class="card-header bg-light">
                    <h5 class="mb-0">Información de Apoderados</h5>
                  </div>
                  <div class="card-body">
                    <!-- Apoderado Titular -->
                    <div class="row g-3 mb-3">
                      <div class="col-12">
                        <h6 class="border-bottom pb-2">Apoderado Titular</h6>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="{{ form.apoderado_titular.id_for_label }}" class="form-label">Nombre Completo</label>
                          <input type="text" class="form-control" id="{{ form.apoderado_titular.id_for_label }}" name="{{ form.apoderado_titular.html_name }}" value="{{ form.apoderado_titular.value|default:'' }}" placeholder="Nombre del apoderado titular">
                          {% if form.apoderado_titular.errors %}
                            <div class="text-danger">
                              {% for error in form.apoderado_titular.errors %}
                                {{ error }}
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="{{ form.rut_apoderadoT.id_for_label }}" class="form-label">RUT</label>
                          <input type="text" class="form-control rut-input" id="{{ form.rut_apoderadoT.id_for_label }}" name="{{ form.rut_apoderadoT.html_name }}" value="{{ form.rut_apoderadoT.value|default:'' }}" placeholder="Ej: 12.345.678-9">
                          {% if form.rut_apoderadoT.errors %}
                            <div class="text-danger">
                              {% for error in form.rut_apoderadoT.errors %}
                                {{ error }}
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                      <div class="col-md-12">
                        <div class="form-group">
                          <label for="{{ form.telefono_apoderadoT.id_for_label }}" class="form-label">Teléfono</label>
                          <div class="input-group">
                            <span class="input-group-text">+56</span>
                            <input type="text" class="form-control telefono-input" id="{{ form.telefono_apoderadoT.id_for_label }}" name="{{ form.telefono_apoderadoT.html_name }}" value="{{ form.telefono_apoderadoT.value|default:'' }}" maxlength="9" placeholder="912345678">
                          </div>
                          <small class="form-text text-muted">Ingrese los 9 dígitos, sin el prefijo +56</small>
                          {% if form.telefono_apoderadoT.errors %}
                            <div class="text-danger">
                              {% for error in form.telefono_apoderadoT.errors %}
                                {{ error }}
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                    
                    <!-- Apoderado Suplente -->
                    <div class="row g-3">
                      <div class="col-12">
                        <h6 class="border-bottom pb-2">Apoderado Suplente <small class="text-muted">(Opcional)</small></h6>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="{{ form.apoderado_suplente.id_for_label }}" class="form-label">Nombre Completo</label>
                          <input type="text" class="form-control" id="{{ form.apoderado_suplente.id_for_label }}" name="{{ form.apoderado_suplente.html_name }}" value="{{ form.apoderado_suplente.value|default:'' }}" placeholder="Nombre del apoderado suplente">
                          {% if form.apoderado_suplente.errors %}
                            <div class="text-danger">
                              {% for error in form.apoderado_suplente.errors %}
                                {{ error }}
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="{{ form.rut_apoderadoS.id_for_label }}" class="form-label">RUT</label>
                          <input type="text" class="form-control rut-input" id="{{ form.rut_apoderadoS.id_for_label }}" name="{{ form.rut_apoderadoS.html_name }}" value="{{ form.rut_apoderadoS.value|default:'' }}" placeholder="Ej: 12.345.678-9">
                          {% if form.rut_apoderadoS.errors %}
                            <div class="text-danger">
                              {% for error in form.rut_apoderadoS.errors %}
                                {{ error }}
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                      <div class="col-md-12">
                        <div class="form-group">
                          <label for="{{ form.telefono_apoderadoS.id_for_label }}" class="form-label">Teléfono</label>
                          <div class="input-group">
                            <span class="input-group-text">+56</span>
                            <input type="text" class="form-control telefono-input" id="{{ form.telefono_apoderadoS.id_for_label }}" name="{{ form.telefono_apoderadoS.html_name }}" value="{{ form.telefono_apoderadoS.value|default:'' }}" maxlength="9" placeholder="912345678">
                          </div>
                          <small class="form-text text-muted">Ingrese los 9 dígitos, sin el prefijo +56</small>
                          {% if form.telefono_apoderadoS.errors %}
                            <div class="text-danger">
                              {% for error in form.telefono_apoderadoS.errors %}
                                {{ error }}
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="d-flex justify-content-end mt-4">
                  <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancelar</button>
                  <button type="submit" class="btn btn-primary">Guardar Alumno</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    
      <!-- Script para SweetAlert -->
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
      
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          // Función para aplicar el formateo de RUT a un elemento
          function aplicarFormateoRut(elemento) {
            elemento.addEventListener('input', function() {
              let valor = this.value.replace(/\./g, '').replace(/-/g, '');
              if (valor.length > 1) {
                // Obtener dígito verificador
                let dv = valor.slice(-1);
                // Obtener cuerpo del RUT
                let rutCuerpo = valor.slice(0, -1);
                // Formatear RUT
                let rutFormateado = '';
                for (let i = rutCuerpo.length; i > 0; i -= 3) {
                  const inicio = Math.max(0, i - 3);
                  rutFormateado = '.' + rutCuerpo.substring(inicio, i) + rutFormateado;
                }
                rutFormateado = rutFormateado.substring(1) + '-' + dv;
                this.value = rutFormateado;
              }
            });
          }
      
          // Función para inicializar todos los campos de RUT
          function inicializarCamposRut() {
            document.querySelectorAll('.rut-input').forEach(aplicarFormateoRut);
            console.log('Campos RUT inicializados:', document.querySelectorAll('.rut-input').length);
          }
      
          // Inicializar campos existentes
          inicializarCamposRut();
      
          // Reinicializar cuando se abre cualquier modal
          document.querySelectorAll('.modal').forEach(function(modal) {
            modal.addEventListener('shown.bs.modal', function() {
              setTimeout(inicializarCamposRut, 100); // Pequeño retraso para asegurar que el DOM está listo
            });
          });
      
          // Observar cambios en el DOM para aplicar formateo a nuevos campos
          const observer = new MutationObserver(function(mutations) {
            let needsInit = false;
            mutations.forEach(function(mutation) {
              if (mutation.addedNodes && mutation.addedNodes.length > 0) {
                needsInit = true;
              }
            });
            if (needsInit) {
              inicializarCamposRut();
            }
          });
      
          observer.observe(document.body, {
            childList: true,
            subtree: true
          });
          
          // Validación de RUT para todos los formularios
          function validarRut(rut) {
            // Eliminar puntos y guiones
            rut = rut.replace(/\./g, '').replace(/-/g, '');
            
            // Verificar longitud mínima
            if (rut.length < 2) return false;
            
            // Separar cuerpo y dígito verificador
            const cuerpo = rut.slice(0, -1);
            const dv = rut.slice(-1).toUpperCase();
            
            // Calcular dígito verificador
            let suma = 0;
            let multiplicador = 2;
            
            // Recorrer el cuerpo de derecha a izquierda
            for (let i = cuerpo.length - 1; i >= 0; i--) {
              suma += parseInt(cuerpo.charAt(i)) * multiplicador;
              multiplicador = multiplicador === 7 ? 2 : multiplicador + 1;
            }
            
            // Calcular dígito esperado
            const resto = suma % 11;
            const dvEsperado = resto === 0 ? '0' : resto === 1 ? 'K' : (11 - resto).toString();
            
            // Comparar dígito verificador
            return dv === dvEsperado;
          }
          
          // Validación al enviar los formularios
          const alumnoForms = document.querySelectorAll('.alumnoForm');
          alumnoForms.forEach(function(form) {
            form.addEventListener('submit', function(e) {
              const rutInputs = this.querySelectorAll('.rut-input');
              let formValido = true;
              
              rutInputs.forEach(function(input) {
                // Solo validar si el campo tiene valor (permite campos opcionales)
                if (input.value.trim() !== '') {
                  if (!validarRut(input.value)) {
                    formValido = false;
                    input.classList.add('is-invalid');
                    
                    // Crear mensaje de error si no existe
                    let errorMsg = input.nextElementSibling;
                    if (!errorMsg || !errorMsg.classList.contains('invalid-feedback')) {
                      errorMsg = document.createElement('div');
                      errorMsg.classList.add('invalid-feedback');
                      input.parentNode.insertBefore(errorMsg, input.nextSibling);
                    }
                    errorMsg.textContent = 'RUT inválido. Verifique el formato y dígito verificador.';
                  } else {
                    input.classList.remove('is-invalid');
                    input.classList.add('is-valid');
                    
                    // Eliminar mensaje de error si existe
                    const errorMsg = input.nextElementSibling;
                    if (errorMsg && errorMsg.classList.contains('invalid-feedback')) {
                      errorMsg.remove();
                    }
                  }
                }
              });
              
              if (!formValido) {
                e.preventDefault();
                Swal.fire({
                  icon: 'error',
                  title: '¡Error de validación!',
                  text: 'Hay uno o más RUTs inválidos en el formulario. Por favor, verifique los campos marcados.',
                  confirmButtonText: 'Entendido'
                });
              }
            });
          });
          
          // También validar formularios de familiares
          const familiarForms = document.querySelectorAll('.familiarForm');
          familiarForms.forEach(function(form) {
            form.addEventListener('submit', function(e) {
              const rutInput = this.querySelector('.rut-input');
              if (rutInput && rutInput.value.trim() !== '' && !validarRut(rutInput.value)) {
                e.preventDefault();
                Swal.fire({
                  icon: 'error',
                  title: '¡RUT inválido!',
                  text: 'El RUT ingresado no es válido. Debe tener formato XX.XXX.XXX-X y un dígito verificador correcto.',
                  confirmButtonText: 'Entendido'
                });
              }
            });
          });
          
          // Manejo de modales anidados
          const detalleModals = document.querySelectorAll('[id^="verDetalleModal"]');
          detalleModals.forEach(function(modal) {
            modal.addEventListener('show.bs.modal', function() {
              // Cuando se muestra el modal de detalles, configuramos los botones para abrir modales anidados
              const addFamiliarBtns = this.querySelectorAll('button[data-bs-target^="#agregarFamiliar"]');
              addFamiliarBtns.forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                  e.preventDefault();
                  const targetModalId = this.getAttribute('data-bs-target');
                  const currentModal = bootstrap.Modal.getInstance(modal);
                  currentModal.hide();
                  setTimeout(function() {
                    const targetModal = new bootstrap.Modal(document.querySelector(targetModalId));
                    targetModal.show();
                  }, 500);
                });
              });
            });
          });
        });
      </script>
      <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Manejar correctamente los modales anidados
            const detalleModals = document.querySelectorAll('[id^="verDetalleModal"]');
            
            detalleModals.forEach(function(detalleModal) {
                // Obtener todos los botones que abren modales anidados dentro de este modal de detalles
                const nestedModalButtons = detalleModal.querySelectorAll('[data-bs-toggle="modal"]');
                
                nestedModalButtons.forEach(function(btn) {
                    const targetModalId = btn.getAttribute('data-bs-target');
                    const targetModal = document.querySelector(targetModalId);
                    
                    if (targetModal) {
                        // Cuando se abre el modal anidado, ocultar (pero no destruir) el modal padre
                        targetModal.addEventListener('show.bs.modal', function() {
                            const detalleModalInstance = bootstrap.Modal.getInstance(detalleModal);
                            if (detalleModalInstance) {
                                // Guardar una referencia al modal padre en el modal hijo
                                targetModal.parentModal = detalleModalInstance;
                                detalleModal.style.display = 'none';
                                // Mantener el fondo oscuro
                                document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                                    backdrop.style.zIndex = '1055'; // Asegurar que el backdrop esté detrás del nuevo modal
                                });
                            }
                        });
                        
                        // Cuando se cierra el modal anidado, restaurar el modal padre
                        targetModal.addEventListener('hidden.bs.modal', function() {
                            if (targetModal.parentModal) {
                                detalleModal.style.display = 'block';
                                detalleModal.classList.add('show');
                                // Asegurarse de que el modal padre siga siendo interactivo
                                detalleModal.style.zIndex = '1050';
                            }
                        });
                        
                        // Manejar específicamente los botones de cancelar/cerrar en el modal anidado
                        const closeButtons = targetModal.querySelectorAll('[data-bs-dismiss="modal"], .btn-close, .btn-secondary');
                        closeButtons.forEach(function(closeBtn) {
                            closeBtn.addEventListener('click', function() {
                                const modalInstance = bootstrap.Modal.getInstance(targetModal);
                                if (modalInstance) {
                                    modalInstance.hide();
                                }
                            });
                        });
                    }
                });
            });
            
            // Limpiar los backdrops huérfanos si los hay
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal-backdrop') && !document.querySelector('.modal.show')) {
                    e.target.remove();
                }
            });
        });
      </script>
      <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Manejar botones de modales anidados
            document.querySelectorAll('.nested-modal-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const targetModalId = this.getAttribute('data-target-modal');
                    const parentModalId = this.getAttribute('data-parent-modal');
                    
                    const targetModal = document.querySelector(targetModalId);
                    const parentModal = document.querySelector(parentModalId);
                    
                    if (targetModal && parentModal) {
                        // Ocultar el modal padre
                        const parentModalInstance = bootstrap.Modal.getInstance(parentModal);
                        if (parentModalInstance) {
                            parentModalInstance.hide();
                        }
                        
                        // Mostrar el modal hijo después de un breve retraso
                        setTimeout(function() {
                            const targetModalInstance = new bootstrap.Modal(targetModal);
                            targetModalInstance.show();
                            
                            // Guardar referencia al modal padre
                            targetModal.parentModalId = parentModalId;
                        }, 300);
                    }
                });
            });
            
            // Manejar el cierre de modales anidados
            document.querySelectorAll('.modal').forEach(function(modal) {
                modal.addEventListener('hidden.bs.modal', function() {
                    if (this.parentModalId) {
                        setTimeout(function() {
                            const parentModal = document.querySelector(modal.parentModalId);
                            if (parentModal) {
                                const parentModalInstance = new bootstrap.Modal(parentModal);
                                parentModalInstance.show();
                            }
                        }, 300);
                    }
                });
            });
        });
      </script>
        
       <!-- Script para manejar la promoción anual -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Botón para abrir el modal de promoción
        const btnPromocionAnual = document.getElementById('btnPromocionAnual');
        if (btnPromocionAnual) {
          btnPromocionAnual.addEventListener('click', function() {
            const promocionModal = new bootstrap.Modal(document.getElementById('promocionAnualModal'));
            promocionModal.show();
          });
        }
        
        // Checkbox de confirmación
        const confirmarPromocion = document.getElementById('confirmarPromocion');
        const btnConfirmarPromocion = document.getElementById('btnConfirmarPromocion');
        
        if (confirmarPromocion && btnConfirmarPromocion) {
          confirmarPromocion.addEventListener('change', function() {
            btnConfirmarPromocion.disabled = !this.checked;
          });
        }
        
        // Formulario de promoción
        const formPromocionAnual = document.getElementById('formPromocionAnual');
        if (formPromocionAnual) {
          formPromocionAnual.addEventListener('submit', function(e) {
            if (!confirmarPromocion.checked) {
              e.preventDefault();
              Swal.fire({
                icon: 'error',
                title: 'Confirmación requerida',
                text: 'Debe confirmar que entiende que esta acción es irreversible',
                confirmButtonText: 'Entendido'
              });
            } else {
              // Mostrar indicador de carga
              btnConfirmarPromocion.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Procesando...';
              btnConfirmarPromocion.disabled = true;
            }
          });
        }
      });
    </script>
      
      
        
      {% if messages %}
          {% for message in messages %}
        <script>
          mensaje('{{ message.tags }}', '{{ message }}');
        </script>
          {% endfor %}
      {% endif %}
    
{% endblock %}