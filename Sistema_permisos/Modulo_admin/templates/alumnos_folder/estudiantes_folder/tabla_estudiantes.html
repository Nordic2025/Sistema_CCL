{% extends 'base_admin.html' %}

{% load static %}

{% block title %}Alumnos{% endblock %}

{% block content %}

<div class="container main-content">
    <h1 style="margin-top: 30px; font-size: 2rem;">Panel de Administrador | Alumnos</h1>  
    
<!-- Boton para avanzar de año -->
    {% if user.is_superuser %}
      <div class="d-flex mb-3">
        <button type="button" class="btn btn_general me-2" data-bs-toggle="modal" data-bs-target="#agregarAlumnoModal">
          Registrar nuevo alumno
        </button>
        <button type="button" class="btn btn-warning" id="btnPromocionAnual">
          <i class="fas fa-graduation-cap"></i> Pasar al Siguiente Año
        </button>
      </div>
    {% endif %}

    <!-- Modal para alerta de confirmacion avnzar al año siguiente --> 
    <div class="modal fade" id="promocionAnualModal" tabindex="-1" aria-labelledby="promocionAnualModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-warning">
            <h5 class="modal-title" id="promocionAnualModalLabel">
              <i class="fas fa-exclamation-triangle"></i> Confirmación de Promoción Anual
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-danger">
              <h4 class="alert-heading text-center">¡ATENCIÓN!</h4>
              <p class="text-center"><strong>Esta acción es IRREVERSIBLE</strong></p>
              <hr>
              <p>Está a punto de promover a todos los alumnos al siguiente año académico:</p>
              <ul>
                <li>Los alumnos avanzarán al siguiente nivel según el sistema educativo</li>
                <li>Los alumnos de 4° Medio serán enviados a la tabla "Egresados"</li>
                <li>Se mantendrán las mismas secciones (letras) por curso</li>
              </ul>
              <p>Los casos especiales (repitentes, traslados, etc.) deberán gestionarse manualmente después de este proceso.</p>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="confirmarPromocion">
              <label class="form-check-label" for="confirmarPromocion">
                Entiendo que esta acción no se puede deshacer
              </label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <form action="{% url 'Modulo_admin:promocion_anual' %}" method="POST" id="formPromocionAnual">
              {% csrf_token %}
              <button type="submit" class="btn btn-warning" id="btnConfirmarPromocion" disabled>
                Confirmar Promoción
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>


    <!-- Filtros combinados (buscador, curso y nivel) -->
    <div class="row mb-4 mt-4">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Filtros</h5>
          </div>
          <div class="card-body">
            <form id="filtroForm" method="get" action="{% url 'Modulo_admin:alumnos' %}" class="row g-3">
              <!-- Buscador -->
              <div class="col-md-4">
                <label for="busqueda" class="form-label">Buscar por nombre o RUT:</label>
                <input type="text" id="busqueda" name="busqueda" class="form-control" placeholder="Nombre o RUT"
                  value="{{ busqueda }}" autocomplete="off">
              </div>

              <!-- Filtro por curso -->
              <div class="col-md-3">
                <label for="curso" class="form-label">Curso:</label>
                <select class="form-select" id="curso" name="curso">
                  <option value="">Todos los cursos</option>
                  {% for curso in cursos %}
                  <option value="{{ curso.id }}" {% if curso_filtro == curso.id|stringformat:"s" %}selected{% endif %}>{{ curso.nombre }}/>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-2 d-flex align-items-end">
                <div class="d-grid gap-2 w-100">
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search"></i> Buscar
                  </button>
                  {% if busqueda or curso_filtro or nivel_filtro %}
                  <a href="{% url 'Modulo_admin:alumnos' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-times"></i> Limpiar filtros
                  </a>
                  {% endif %}
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>


    <!-- Indicadores de filtros activos -->
    {% if busqueda or curso_filtro or nivel_filtro %}
    <div class="row mb-4">
      <div class="col-md-12">
        <div class="alert alert-info">
          <h5 class="alert-heading">Filtros activos:</h5>
          <ul class="mb-0">
            {% if busqueda %}
            <li>Búsqueda: <strong>{{ busqueda }}</strong></li>
            {% endif %}
            {% if curso_filtro %}
            <li>Curso: <strong>{{ curso_nombre }}</strong></li>
            {% endif %}
            </ul>
        </div>
      </div>
    </div>
    {% endif %}

    <div class="row">
      <div class="col-md-12">
        <div class="tabla_global">
          <table class="tabla_ancha">
            <thead class="thead_custom">
              <tr>
                <th>RUT</th>
                <th>Nombre</th>
                <th>Curso</th>
                <th>Apoderado Titular</th>
                <th>Rut Apoderado Titular</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody class="tbody_custom">
              {% for alumno in alumnos %}
              <tr>
                <td>{{ alumno.rut }}</td>
                <td>{{ alumno.nombre }}</td>
                <td>{{ alumno.curso }}</td>
                <td>{{ alumno.apoderado_titular }}</td>
                <td>{{ alumno.rut_apoderadoT }}</td>
                <td>
                  {% if user.is_superuser %}
                  <button type="button" class="btn btn_editar btn-outline-warning m-1" 
                          data-bs-toggle="modal" 
                          data-bs-target="#editarAlumnoModal{{ alumno.id }}">
                    Editar
                  </button>
                  {% endif %}
                  <button type="button" class="btn btn_primary btn-outline-primary m-1" 
                          data-bs-toggle="modal" 
                          data-bs-target="#verDetalleModal{{ alumno.id }}">
                    Ver Detalle
                  </button>
                </td>
              </tr>
              
              {% if user.is_superuser %}
              <!-- Modal para Editar Alumno -->
              <div class="modal fade" id="editarAlumnoModal{{ alumno.id }}" tabindex="-1" aria-labelledby="editarAlumnoModalLabel{{ alumno.id }}" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                  <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                      <h5 class="modal-title" id="editarAlumnoModalLabel{{ alumno.id }}">Editar Alumno</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <form method="POST" action="{% url 'Modulo_admin:editar_alumno' alumno.id %}" class="alumnoForm">
                        {% csrf_token %}
                        <input type="hidden" name= "current_page" value="{{page_obj.number}}">
                        <input type="hidden" name= "busqueda" value="{{curso_filtro}}">
                        <input type="hidden" name="curso_filtro" value="{{curso_filtro}}">
                        <!-- Información del Alumno -->
                        <div class="card mb-4">
                          <div class="card-header bg-light">
                            <h5 class="mb-0">Información del Alumno</h5>
                          </div>
                          <div class="card-body">
                            <div class="row g-3">
                              <div class="col-md-4">
                                <div class="form-group">
                                  <label for="rut{{ alumno.id }}" class="form-label">RUT</label>
                                  <input type="text" class="form-control rut-input" id="rut{{ alumno.id }}" name="rut" value="{{ alumno.rut|default:'' }}" maxlength="12">
                                </div>
                              </div>
                              <div class="col-md-8">
                                <div class="form-group">
                                  <label for="nombre{{ alumno.id }}" class="form-label">Nombre Completo</label>
                                  <input type="text" class="form-control" id="nombre{{ alumno.id }}" name="nombre" value="{{ alumno.nombre|default:'' }}">
                                </div>
                              </div>
                              <div class="col-md-12">
                                <div class="form-group">
                                  <label for="curso{{ alumno.id }}" class="form-label">Curso</label>
                                  <select class="form-control" id="curso{{ alumno.id }}" name="curso">
                                    {% for curso in cursos %}
                                      <option value="{{ curso.id }}" {% if alumno.curso.id == curso.id %}selected{% endif %}>{{ curso.nombre }}/>
                                    {% endfor %}
                                  </select>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        
                        <!-- Información de Apoderados -->
                        <div class="card mb-4">
                          <div class="card-header bg-light">
                            <h5 class="mb-0">Información de Apoderados</h5>
                          </div>
                          <div class="card-body">
                            <!-- Apoderado Titular -->
                            <div class="row g-3 mb-3">
                              <div class="col-12">
                                <h6 class="border-bottom pb-2">Apoderado Titular</h6>
                              </div>
                              <div class="col-md-6">
                                <div class="form-group">
                                  <label for="apoderado_titular{{ alumno.id }}" class="form-label">Nombre Completo</label>
                                  <input type="text" class="form-control" id="apoderado_titular{{ alumno.id }}" name="apoderado_titular" value="{{ alumno.apoderado_titular|default:'' }}" maxlength="12">
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="form-group">
                                  <label for="rut_apoderadoT{{ alumno.id }}" class="form-label">RUT</label>
                                  <input type="text" class="form-control rut-input" id="rut_apoderadoT{{ alumno.id }}" name="rut_apoderadoT" value="{{ alumno.rut_apoderadoT|default:'' }}" maxlength="12">
                                </div>
                              </div>
                              <div class="col-md-12">
                                <div class="form-group">
                                  <label for="telefono_apoderadoT{{ alumno.id }}" class="form-label">Teléfono</label>
                                  <div class="input-group">
                                    <span class="input-group-text">+56</span>
                                    {% if alumno.telefono_apoderadoT|default:''|slice:':3' == '+56' %}
                                      <input type="text" class="form-control telefono-input" id="telefono_apoderadoT{{ alumno.id }}" name="telefono_apoderadoT" value="{{ alumno.telefono_apoderadoT|default:''|slice:'3:' }}" maxlength="9">
                                    {% else %}
                                      <input type="text" class="form-control telefono-input" id="telefono_apoderadoT{{ alumno.id }}" name="telefono_apoderadoT" value="{{ alumno.telefono_apoderadoT|default:'' }}" maxlength="9">
                                    {% endif %}
                                  </div>
                                  <small class="form-text text-muted">Ingrese los 9 dígitos, sin el prefijo +56</small>
                                </div>
                              </div>
                            </div>
                            
                            <!-- Apoderado Suplente -->
                            <div class="row g-3">
                              <div class="col-12">
                                <h6 class="border-bottom pb-2">Apoderado Suplente</h6>
                              </div>
                              <div class="col-md-6">
                                <div class="form-group">
                                  <label for="apoderado_suplente{{ alumno.id }}" class="form-label">Nombre Completo</label>
                                  <input type="text" class="form-control" id="apoderado_suplente{{ alumno.id }}" name="apoderado_suplente" value="{{ alumno.apoderado_suplente|default:'' }}">
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="form-group">
                                  <label for="rut_apoderadoS{{ alumno.id }}" class="form-label">RUT</label>
                                  <input type="text" class="form-control rut-input" id="rut_apoderadoS{{ alumno.id }}" name="rut_apoderadoS" value="{{ alumno.rut_apoderadoS|default:'' }}" maxlength="12">
                                </div>
                              </div>
                              <div class="col-md-12">
                                <div class="form-group">
                                  <label for="telefono_apoderadoS{{ alumno.id }}" class="form-label">Teléfono</label>
                                  <div class="input-group">
                                    <span class="input-group-text">+56</span>
                                    <input type="text" class="form-control telefono-input" id="telefono_apoderadoS{{ alumno.id }}" name="telefono_apoderadoS" value="{{ alumno.telefono_apoderadoS|default:''|slice:'3:' }}" maxlength="9">
                                  </div>
                                  <small class="form-text text-muted">Ingrese los 9 dígitos, sin el prefijo +56</small>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        
                        <!-- Información de Familiares -->
                        <div class="row">
                          <!-- Familiar 1 -->
                          <div class="col-md-6">
                            <div class="card mb-4 h-100">
                              <div class="card-header bg-light">
                                <h5 class="mb-0">Familiar 1</h5>
                              </div>
                              <div class="card-body">
                                <div class="form-group mb-3">
                                  <label for="familiar_1{{ alumno.id }}" class="form-label">Nombre Completo</label>
                                  <input type="text" class="form-control" id="familiar_1{{ alumno.id }}" name="familiar_1" value="{{ alumno.familiar_1|default:'' }}">
                                </div>
                                <div class="form-group mb-3">
                                  <label for="rut_familiar_1{{ alumno.id }}" class="form-label">RUT</label>
                                  <input type="text" class="form-control rut-input" id="rut_familiar_1{{ alumno.id }}" name="rut_familiar_1" value="{{ alumno.rut_familiar_1|default:'' }}" maxlength="12">
                                </div>
                                <div class="form-group mb-3">
                                  <label for="familiar_1_relacion{{ alumno.id }}" class="form-label">Relación</label>
                                  <input type="text" class="form-control" id="familiar_1_relacion{{ alumno.id }}" name="familiar_1_relacion" value="{{ alumno.familiar_1_relacion|default:'' }}">
                                </div>
                                <div class="form-group">
                                  <label for="familiar_1_telefono{{ alumno.id }}" class="form-label">Teléfono</label>
                                  <div class="input-group">
                                    <span class="input-group-text">+56</span>
                                    <input type="text" class="form-control telefono-input" id="familiar_1_telefono{{ alumno.id }}" name="familiar_1_telefono" value="{{ alumno.familiar_1_telefono|default:''|slice:'3:' }}" maxlength="9">
                                  </div>
                                  <small class="form-text text-muted">Ingrese los 9 dígitos, sin el prefijo +56</small>
                                </div>
                              </div>
                            </div>
                          </div>
                          
                          <!-- Familiar 2 -->
                          <div class="col-md-6">
                            <div class="card mb-4 h-100">
                              <div class="card-header bg-light">
                                <h5 class="mb-0">Familiar 2</h5>
                              </div>
                              <div class="card-body">
                                <div class="form-group mb-3">
                                  <label for="familiar_2{{ alumno.id }}" class="form-label">Nombre Completo</label>
                                  <input type="text" class="form-control" id="familiar_2{{ alumno.id }}" name="familiar_2" value="{{ alumno.familiar_2|default:'' }}">
                                </div>
                                <div class="form-group mb-3">
                                  <label for="rut_familiar_2{{ alumno.id }}" class="form-label">RUT</label>
                                  <input type="text" class="form-control rut-input" id="rut_familiar_2{{ alumno.id }}" name="rut_familiar_2" value="{{ alumno.rut_familiar_2|default:'' }}" maxlength="12">
                                </div>
                                <div class="form-group mb-3">
                                  <label for="familiar_2_relacion{{ alumno.id }}" class="form-label">Relación</label>
                                  <input type="text" class="form-control" id="familiar_2_relacion{{ alumno.id }}" name="familiar_2_relacion" value="{{ alumno.familiar_2_relacion|default:'' }}">
                                </div>
                                <div class="form-group">
                                  <label for="familiar_2_telefono{{ alumno.id }}" class="form-label">Teléfono</label>
                                  <div class="input-group">
                                    <span class="input-group-text">+56</span>
                                    <input type="text" class="form-control telefono-input" id="familiar_2_telefono{{ alumno.id }}" name="familiar_2_telefono" value="{{ alumno.familiar_2_telefono|default:''|slice:'3:' }}" maxlength="9">
                                  </div>
                                  <small class="form-text text-muted">Ingrese los 9 dígitos, sin el prefijo +56</small>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        
                        <div class="d-flex justify-content-end mt-4">
                          <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancelar</button>
                          <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
                <!-- Script para validar que el Rut ingresado no se de un alumno egresado -->
                <script>
                  document.addEventListener('DOMContentLoaded', function() {
                    const rutInput = document.getElementById('rut{{ alumno.id }}');
                    if (rutInput) {
                      rutInput.addEventListener('blur', function() {
                        verificarRutEgresado(this);
                      });
                    }
                  });
                </script>
              </div>
              {% endif %}

              <!-- Modal para Ver Detalle -->
              <div class="modal fade" id="verDetalleModal{{ alumno.id }}" tabindex="-1" aria-labelledby="verDetalleModalLabel{{ alumno.id }}" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="verDetalleModalLabel{{ alumno.id }}">Detalles del Alumno | {{ alumno.nombre }}</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <div class="row">
                        <div class="col-md-6">
                          <div class="card mb-3">
                            <div class="card-body">
                              <h5 class="card-title">Información Personal</h5>
                              <p><strong>RUT:</strong> {{ alumno.rut }}</p>
                              <p><strong>Nombre Completo:</strong> {{ alumno.nombre }}</p>
                              <p><strong>Curso:</strong> {{ alumno.curso.nombre }}</p>
                            </div>
                          </div>
                          
                          <div class="card">
                            <div class="card-body">
                              <h5 class="card-title">Apoderados</h5>
                              <p><strong>Apoderado Titular:</strong> {{ alumno.apoderado_titular }}</p>
                              <p><strong>RUT Apoderado Titular:</strong> {{ alumno.rut_apoderadoT|default:"No registrado" }}</p>
                              <p><strong>Telefono Apoderado Titular:</strong> {{ alumno.telefono_apoderadoT|default:"No registrado" }}</p>
                              <p><strong>Apoderado Suplente:</strong> {{ alumno.apoderado_suplente|default:"No registrado" }}</p>
                              <p><strong>RUT Apoderado Suplente:</strong> {{ alumno.rut_apoderadoS|default:"No registrado" }}</p>
                              <p><strong>Telefono Apoderado Suplente:</strong> {{ alumno.telefono_apoderadoS|default:"No registrado" }}</p>
                            </div>
                          </div>
                        </div>
                        
                        <div class="col-md-6">
                          <h5 class="card-title mb-3">Familiares Adicionales</h5>
                          
                          <div class="familiar-1-container">
                            {% if alumno.familiar_1 %}
                              <div class="card mb-3">
                                <div class="card-body">
                                  <div class="d-flex justify-content-between align-items-start">
                                    <h6 class="card-subtitle  text-muted">Familiar 1</h6>
                                    {% if user.is_superuser %}
                                    <button type="button" class="btn btn-sm btn-danger " 
                                      onclick="confirmarEliminarFamiliar('{{ alumno.id }}', 1, '{{ alumno.familiar_1 }}')">
                                      Eliminar  
                                    </button>
                                    {% endif %}
                                  </div>
                                  <p><strong>Nombre:</strong> {{ alumno.familiar_1 }}</p>
                                  <p><strong>RUT:</strong> {{ alumno.rut_familiar_1|default:"No registrado" }}</p>
                                  <p><strong>Relación:</strong> {{ alumno.familiar_1_relacion|default:"No especificada" }}</p>
                                  <p><strong>Teléfono:</strong> {{ alumno.familiar_1_telefono|default:"No registrado" }}</p>
                                </div>
                              </div>
                              {% else %}
                              <div class="mb-3">
                              <button type="button" class="btn btn-sm btn-success nested-modal-btn" 
                                data-target-modal="#agregarFamiliar1Modal{{ alumno.id }}"
                                data-parent-modal="#verDetalleModal{{ alumno.id }}"
                                data-bs-backdrop="static">
                                  + Añadir Familiar 1
                              </button>
                              </div>
                            {% endif %}
                          </div>
  
                          
                          <div class="familiar-2-container">
                            {% if alumno.familiar_2 %}
                              <div class="card">
                                <div class="card-body">
                                  <div class="d-flex justify-content-between align-items-start">
                                    <h6 class="card-subtitle mb-2 text-muted">Familiar 2</h6>
                                    {% if user.is_superuser %}
                                    <button type="button" class="btn btn-sm btn-danger " 
                                      onclick="confirmarEliminarFamiliar('{{ alumno.id }}', 2, '{{ alumno.familiar_1 }}')">
                                      Eliminar  
                                    </button>
                                    {% endif %}
                                  </div>
                                  <p><strong>Nombre:</strong> {{ alumno.familiar_2 }}</p>
                                  <p><strong>RUT:</strong> {{ alumno.rut_familiar_2|default:"No registrado" }}</p>
                                  <p><strong>Relación:</strong> {{ alumno.familiar_2_relacion|default:"No especificada" }}</p>
                                  <p><strong>Teléfono:</strong> {{ alumno.familiar_2_telefono|default:"No registrado" }}</p>
                                </div>
                              </div>
                              {% elif alumno.familiar_1 %}
                                <div>
                                  <button type="button" class="btn btn-sm btn-success nested-modal-btn" 
                                        data-target-modal="#agregarFamiliar2Modal{{ alumno.id }}"
                                        data-parent-modal="#verDetalleModal{{ alumno.id }}"
                                        data-bs-backdrop="static">
                                    + Añadir Familiar 2
                                  </button>
                                </div>
                              {% endif %}
                          </div>

                        </div>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                  </div>
                </div>
              </div>
                  <!-- Modal para Añadir Familiar 1 -->
                  <div class="modal fade" id="agregarFamiliar1Modal{{ alumno.id }}" tabindex="-1" aria-labelledby="agregarFamiliar1ModalLabel{{ alumno.id }}" aria-hidden="true" data-bs-backdrop="static">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="agregarFamiliar1ModalLabel{{ alumno.id }}">Añadir Familiar 1 | {{ alumno.nombre }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form method="POST" action="{% url 'Modulo_admin:agregar_familiar' alumno.id 1 %}" class="familiarForm">
                                    {% csrf_token %}
                                {% csrf_token %}
                                <div class="mb-3">
                                  <label for="{{ familiar_form.familiar_nombre.id_for_label }}" class="form-label">Nombre del Familiar</label>
                                  {{ familiar_form.familiar_nombre }}
                                  {% if familiar_form.familiar_nombre.errors %}
                                    <div class="text-danger">
                                      {% for error in familiar_form.familiar_nombre.errors %}
                                        {{ error }}
                                      {% endfor %}
                                    </div>
                                  {% endif %}
                                </div>
                                <div class="mb-3">
                                  <label for="{{ familiar_form.familiar_rut.id_for_label }}" class="form-label">RUT del Familiar</label>
                                  {{ familiar_form.familiar_rut }}
                                  {% if familiar_form.familiar_rut.errors %}
                                    <div class="text-danger">
                                      {% for error in familiar_form.familiar_rut.errors %}
                                        {{ error }}
                                      {% endfor %}
                                    </div>
                                  {% endif %}
                                </div>
                                <div class="mb-3">
                                  <label for="{{ familiar_form.familiar_relacion.id_for_label }}" class="form-label">Relación con el Alumno</label>
                                  {{ familiar_form.familiar_relacion }}
                                  {% if familiar_form.familiar_relacion.errors %}
                                    <div class="text-danger">
                                      {% for error in familiar_form.familiar_relacion.errors %}
                                        {{ error }}
                                      {% endfor %}
                                    </div>
                                  {% endif %}
                                </div>
                                <div class="form-group mb-3">
                                  <label for="familiar_telefono" class="form-label">Teléfono de Contacto</label>
                                  <div class="input-group">
                                    <span class="input-group-text">+56</span>
                                    <input type="text" class="form-control telefono-input" id="familiar_telefono" name="familiar_telefono" value="{{ familiar_form.familiar_telefono.value|default:'' }}" required maxlength="9" placeholder="912345678">
                                  </div>
                                  <small class="form-text text-muted">Ingrese los 9 dígitos, sin el prefijo +56</small>
                                  {% if familiar_form.familiar_telefono.errors %}
                                    <div class="text-danger">
                                      {% for error in familiar_form.familiar_telefono.errors %}
                                        {{ error }}
                                      {% endfor %}
                                    </div>
                                  {% endif %}
                                </div>
                                <div class="modal-footer">
                                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                  <button type="submit" class="btn btn-success">Guardar Familiar</button>
                              </div>
                          </form>
                      </div>
                </div>
            </div>
          </div>

          <!-- Modal para Añadir Familiar 2 -->
          <div class="modal fade" id="agregarFamiliar2Modal{{ alumno.id }}" tabindex="-1" aria-labelledby="agregarFamiliar2ModalLabel{{ alumno.id }}" aria-hidden="true" data-bs-backdrop="static">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="agregarFamiliar2ModalLabel{{ alumno.id }}">Añadir Familiar 2 | {{ alumno.nombre }}</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <form method="POST" action="{% url 'Modulo_admin:agregar_familiar' alumno.id 2 %}" class="familiarForm">
                    {% csrf_token %}
                    <div class="mb-3">
                      <label for="{{ familiar_form.familiar_nombre.id_for_label }}" class="form-label">Nombre del Familiar</label>
                      <input type="text" class="form-control" id="{{ familiar_form.familiar_nombre.id_for_label }}" name="{{ familiar_form.familiar_nombre.html_name }}" value="{{ familiar_form.familiar_nombre.value|default:'' }}" placeholder="Nombre completo">
                      {% if familiar_form.familiar_nombre.errors %}
                        <div class="text-danger">
                          {% for error in familiar_form.familiar_nombre.errors %}
                            {{ error }}
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>
                    <div class="mb-3">
                      <label for="{{ familiar_form.familiar_rut.id_for_label }}" class="form-label">RUT del Familiar</label>
                      <input type="text" class="form-control rut-input" id="{{ familiar_form.familiar_rut.id_for_label }}" name="{{ familiar_form.familiar_rut.html_name }}" value="{{ familiar_form.familiar_rut.value|default:'' }}" placeholder="Ej: 12.345.678-9" maxlength="12" >
                      {% if familiar_form.familiar_rut.errors %}
                        <div class="text-danger">
                          {% for error in familiar_form.familiar_rut.errors %}
                            {{ error }}
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>
                    <div class="mb-3">
                      <label for="{{ familiar_form.familiar_relacion.id_for_label }}" class="form-label">Relación con el Alumno</label>
                      <input type="text" class="form-control" id="{{ familiar_form.familiar_relacion.id_for_label }}" name="{{ familiar_form.familiar_relacion.html_name }}" value="{{ familiar_form.familiar_relacion.value|default:'' }}" placeholder="Ej: Abuelo, Tío, etc.">
                      {% if familiar_form.familiar_relacion.errors %}
                        <div class="text-danger">
                          {% for error in familiar_form.familiar_relacion.errors %}
                            {{ error }}
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>
                    <div class="form-group mb-3">
                      <label for="familiar_telefono" class="form-label">Teléfono de Contacto</label>
                      <div class="input-group">
                        <span class="input-group-text">+56</span>
                        <input type="text" class="form-control telefono-input" id="familiar_telefono" name="familiar_telefono" value="{{ familiar_form.familiar_telefono.value|default:'' }}" required maxlength="9" placeholder="912345678">
                      </div>
                      <small class="form-text text-muted">Ingrese los 9 dígitos, sin el prefijo +56</small>
                      {% if familiar_form.familiar_telefono.errors %}
                        <div class="text-danger">
                          {% for error in familiar_form.familiar_telefono.errors %}
                            {{ error }}
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                      <button type="submit" class="btn btn-success">Guardar Familiar</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
              {% empty %}
              <tr>
                <td colspan="9" class="text-center py-3">
                  <div class="alert alert-info mb-0">
                    No hay alumnos registrados para los criterios seleccionados.
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>


  
      {% if user.is_superuser %}
      <!-- Modal para Agregar Alumno -->
      <div class="modal fade" id="agregarAlumnoModal" tabindex="-1" aria-labelledby="agregarAlumnoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title" id="agregarAlumnoModalLabel">Registrar nuevo Alumno</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form method="POST" action="{% url 'Modulo_admin:agregar_alumno' %}" class="alumnoForm">
                {% csrf_token %}
                
                <!-- Información del Alumno -->
                <div class="card mb-4">
                  <div class="card-header bg-light">
                    <h5 class="mb-0">Información del Alumno</h5>
                  </div>
                  <div class="card-body">
                    <div class="row g-3">
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="{{ form.rut.id_for_label }}" class="form-label">RUT</label>
                          <input type="text" class="form-control rut-input" id="{{ form.rut.id_for_label }}" name="{{ form.rut.html_name }}" value="{{ form.rut.value|default:'' }}" placeholder="Ej: 12.345.678-9" maxlength="12">
                          {% if form.rut.errors %}
                            <div class="text-danger">
                              {% for error in form.rut.errors %}
                                {{ error }}
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                      <div class="col-md-8">
                        <div class="form-group">
                          <label for="{{ form.nombre.id_for_label }}" class="form-label">Nombre Completo</label>
                          <input type="text" class="form-control" id="{{ form.nombre.id_for_label }}" name="{{ form.nombre.html_name }}" value="{{ form.nombre.value|default:'' }}" placeholder="Nombre completo del alumno">
                          {% if form.nombre.errors %}
                            <div class="text-danger">
                              {% for error in form.nombre.errors %}
                                {{ error }}
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                      <div class="col-md-12">
                        <div class="form-group">
                          <label for="{{ form.curso.id_for_label }}" class="form-label">Curso</label>
                          <select class="form-control" id="{{ form.curso.id_for_label }}" name="{{ form.curso.html_name }}">
                            <option value="">Seleccione un curso</option>
                            {% for curso in cursos %}
                              <option value="{{ curso.id }}" {% if form.curso.value == curso.id %}selected{% endif %}>{{ curso.nombre }}</option>
                            {% endfor %}
                          </select>
                          {% if form.curso.errors %}
                            <div class="text-danger">
                              {% for error in form.curso.errors %}
                                {{ error }}
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Información de Apoderados -->
                <div class="card mb-4">
                  <div class="card-header bg-light">
                    <h5 class="mb-0">Información de Apoderados</h5>
                  </div>
                  <div class="card-body">
                    <!-- Apoderado Titular -->
                    <div class="row g-3 mb-3">
                      <div class="col-12">
                        <h6 class="border-bottom pb-2">Apoderado Titular</h6>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="{{ form.apoderado_titular.id_for_label }}" class="form-label">Nombre Completo</label>
                          <input type="text" class="form-control" id="{{ form.apoderado_titular.id_for_label }}" name="{{ form.apoderado_titular.html_name }}" value="{{ form.apoderado_titular.value|default:'' }}" placeholder="Nombre del apoderado titular">
                          {% if form.apoderado_titular.errors %}
                            <div class="text-danger">
                              {% for error in form.apoderado_titular.errors %}
                                {{ error }}
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="{{ form.rut_apoderadoT.id_for_label }}" class="form-label">RUT</label>
                          <input type="text" class="form-control rut-input" id="{{ form.rut_apoderadoT.id_for_label }}" name="{{ form.rut_apoderadoT.html_name }}" value="{{ form.rut_apoderadoT.value|default:'' }}" placeholder="Ej: 12.345.678-9" maxlength="12">
                          {% if form.rut_apoderadoT.errors %}
                            <div class="text-danger">
                              {% for error in form.rut_apoderadoT.errors %}
                                {{ error }}
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                      <div class="col-md-12">
                        <div class="form-group">
                          <label for="{{ form.telefono_apoderadoT.id_for_label }}" class="form-label">Teléfono</label>
                          <div class="input-group">
                            <span class="input-group-text">+56</span>
                            <input type="text" class="form-control telefono-input" id="{{ form.telefono_apoderadoT.id_for_label }}" name="{{ form.telefono_apoderadoT.html_name }}" value="{{ form.telefono_apoderadoT.value|default:'' }}" maxlength="9" placeholder="912345678">
                          </div>
                          <small class="form-text text-muted">Ingrese los 9 dígitos, sin el prefijo +56</small>
                          {% if form.telefono_apoderadoT.errors %}
                            <div class="text-danger">
                              {% for error in form.telefono_apoderadoT.errors %}
                                {{ error }}
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                    
                    <!-- Apoderado Suplente -->
                    <div class="row g-3">
                      <div class="col-12">
                        <h6 class="border-bottom pb-2">Apoderado Suplente <small class="text-muted">(Opcional)</small></h6>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="{{ form.apoderado_suplente.id_for_label }}" class="form-label">Nombre Completo</label>
                          <input type="text" class="form-control" id="{{ form.apoderado_suplente.id_for_label }}" name="{{ form.apoderado_suplente.html_name }}" value="{{ form.apoderado_suplente.value|default:'' }}" placeholder="Nombre del apoderado suplente">
                          {% if form.apoderado_suplente.errors %}
                            <div class="text-danger">
                              {% for error in form.apoderado_suplente.errors %}
                                {{ error }}
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="{{ form.rut_apoderadoS.id_for_label }}" class="form-label">RUT</label>
                          <input type="text" class="form-control rut-input" id="{{ form.rut_apoderadoS.id_for_label }}" name="{{ form.rut_apoderadoS.html_name }}" value="{{ form.rut_apoderadoS.value|default:'' }}" placeholder="Ej: 12.345.678-9" maxlength="12">
                          {% if form.rut_apoderadoS.errors %}
                            <div class="text-danger">
                              {% for error in form.rut_apoderadoS.errors %}
                                {{ error }}
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                      <div class="col-md-12">
                        <div class="form-group">
                          <label for="{{ form.telefono_apoderadoS.id_for_label }}" class="form-label">Teléfono</label>
                          <div class="input-group">
                            <span class="input-group-text">+56</span>
                            <input type="text" class="form-control telefono-input" id="{{ form.telefono_apoderadoS.id_for_label }}" name="{{ form.telefono_apoderadoS.html_name }}" value="{{ form.telefono_apoderadoS.value|default:'' }}" maxlength="9" placeholder="912345678">
                          </div>
                          <small class="form-text text-muted">Ingrese los 9 dígitos, sin el prefijo +56</small>
                          {% if form.telefono_apoderadoS.errors %}
                            <div class="text-danger">
                              {% for error in form.telefono_apoderadoS.errors %}
                                {{ error }}
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="d-flex justify-content-end mt-4">
                  <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancelar</button>
                  <button type="submit" class="btn btn-primary">Guardar Alumno</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      {% endif %}



      <!-- Navegación de paginación con estilos mejorados -->
      <div class="pagination-container my-4">
        <nav aria-label="Navegación de páginas">
          <ul class="pagination pagination-md justify-content-center">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page=1{% if busqueda %}&busqueda={{ busqueda }}{% endif %}{% if curso_filtro %}&curso={{ curso_filtro }}{% endif %}" aria-label="Primera">
                  <span aria-hidden="true">&laquo;&laquo;</span>
                  <span class="d-none d-sm-inline">Primera</span>
                </a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if busqueda %}&busqueda={{ busqueda }}{% endif %}{% if curso_filtro %}&curso={{ curso_filtro }}{% endif %}" aria-label="Anterior">
                  <span aria-hidden="true">&laquo;</span>
                  <span class="d-none d-sm-inline">Anterior</span>
                </a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">
                  <span aria-hidden="true">&laquo;&laquo;</span>
                  <span class="d-none d-sm-inline">Primera</span>
                </span>
              </li>
              <li class="page-item disabled">
                <span class="page-link">
                  <span aria-hidden="true">&laquo;</span>
                  <span class="d-none d-sm-inline">Anterior</span>
                </span>
              </li>
            {% endif %}

            <!-- Indicador de página actual -->
            <li class="page-item active">
              <span class="page-link">
                Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
              </span>
            </li>

            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if busqueda %}&busqueda={{ busqueda }}{% endif %}{% if curso_filtro %}&curso={{ curso_filtro }}{% endif %}" aria-label="Siguiente">
                  <span class="d-none d-sm-inline">Siguiente</span>
                  <span aria-hidden="true">&raquo;</span>
                </a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if busqueda %}&busqueda={{ busqueda }}{% endif %}{% if curso_filtro %}&curso={{ curso_filtro }}{% endif %}" aria-label="Última">
                  <span class="d-none d-sm-inline">Última</span>
                  <span aria-hidden="true">&raquo;&raquo;</span>
                </a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">
                  <span class="d-none d-sm-inline">Siguiente</span>
                  <span aria-hidden="true">&raquo;</span>
                </span>
              </li>
              <li class="page-item disabled">
                <span class="page-link">
                  <span class="d-none d-sm-inline">Última</span>
                  <span aria-hidden="true">&raquo;&raquo;</span>
                </span>
              </li>
            {% endif %}
          </ul>
        </nav>
        
        <!-- Información adicional sobre registros -->
        <div class="text-center text-muted mt-2">
          <small>Mostrando registros {{ page_obj.start_index }} al {{ page_obj.end_index }} de {{ total_registros }} en total</small>
        </div>
      </div>
    
      <!-- Script para SweetAlert -->
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
      
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          // Función para aplicar el formateo de RUT a un elemento
          function aplicarFormateoRut(elemento) {
            elemento.addEventListener('input', function() {
              let valor = this.value.replace(/\./g, '').replace(/-/g, '');
              if (valor.length > 1) {
                // Obtener dígito verificador
                let dv = valor.slice(-1);
                // Obtener cuerpo del RUT
                let rutCuerpo = valor.slice(0, -1);
                // Formatear RUT
                let rutFormateado = '';
                for (let i = rutCuerpo.length; i > 0; i -= 3) {
                  const inicio = Math.max(0, i - 3);
                  rutFormateado = '.' + rutCuerpo.substring(inicio, i) + rutFormateado;
                }
                rutFormateado = rutFormateado.substring(1) + '-' + dv;
                this.value = rutFormateado;
              }
            });
          }
      
          // Función para inicializar todos los campos de RUT
          function inicializarCamposRut() {
            document.querySelectorAll('.rut-input').forEach(aplicarFormateoRut);
            console.log('Campos RUT inicializados:', document.querySelectorAll('.rut-input').length);
          }
      
          // Inicializar campos existentes
          inicializarCamposRut();
      
          // Reinicializar cuando se abre cualquier modal
          document.querySelectorAll('.modal').forEach(function(modal) {
            modal.addEventListener('shown.bs.modal', function() {
              setTimeout(inicializarCamposRut, 100);
            });
          });
      
          // Observar cambios en el DOM para aplicar formateo a nuevos campos
          const observer = new MutationObserver(function(mutations) {
            let needsInit = false;
            mutations.forEach(function(mutation) {
              if (mutation.addedNodes && mutation.addedNodes.length > 0) {
                needsInit = true;
              }
            });
            if (needsInit) {
              inicializarCamposRut();
            }
          });
      
          observer.observe(document.body, {
            childList: true,
            subtree: true
          });
          
          // Validación de RUT para todos los formularios
          function validarRut(rut) {
            // Eliminar puntos y guiones
            rut = rut.replace(/\./g, '').replace(/-/g, '');
            
            // Verificar longitud mínima
            if (rut.length < 2) return false;
            
            // Separar cuerpo y dígito verificador
            const cuerpo = rut.slice(0, -1);
            const dv = rut.slice(-1).toUpperCase();
            
            // Calcular dígito verificador
            let suma = 0;
            let multiplicador = 2;
            
            // Recorrer el cuerpo de derecha a izquierda
            for (let i = cuerpo.length - 1; i >= 0; i--) {
              suma += parseInt(cuerpo.charAt(i)) * multiplicador;
              multiplicador = multiplicador === 7 ? 2 : multiplicador + 1;
            }
            
            // Calcular dígito esperado
            const resto = suma % 11;
            const dvEsperado = resto === 0 ? '0' : resto === 1 ? 'K' : (11 - resto).toString();
            
            // Comparar dígito verificador
            return dv === dvEsperado;
          }
          
          // Validación al enviar los formularios
          const alumnoForms = document.querySelectorAll('.alumnoForm');
          alumnoForms.forEach(function(form) {
            form.addEventListener('submit', function(e) {
              const rutInputs = this.querySelectorAll('.rut-input');
              let formValido = true;
              
              rutInputs.forEach(function(input) {
                // Solo validar si el campo tiene valor
                if (input.value.trim() !== '') {
                  if (!validarRut(input.value)) {
                    formValido = false;
                    input.classList.add('is-invalid');
                    
                    // Crear mensaje de error si no existe
                    let errorMsg = input.nextElementSibling;
                    if (!errorMsg || !errorMsg.classList.contains('invalid-feedback')) {
                      errorMsg = document.createElement('div');
                      errorMsg.classList.add('invalid-feedback');
                      input.parentNode.insertBefore(errorMsg, input.nextSibling);
                    }
                    errorMsg.textContent = 'RUT inválido. Verifique el formato y dígito verificador.';
                  } else {
                    input.classList.remove('is-invalid');
                    input.classList.add('is-valid');
                    
                    // Eliminar mensaje de error si existe
                    const errorMsg = input.nextElementSibling;
                    if (errorMsg && errorMsg.classList.contains('invalid-feedback')) {
                      errorMsg.remove();
                    }
                  }
                }
              });
              
              if (!formValido) {
                e.preventDefault();
                Swal.fire({
                  icon: 'error',
                  title: '¡Error de validación!',
                  text: 'Hay uno o más RUTs inválidos en el formulario. Por favor, verifique los campos marcados.',
                  confirmButtonText: 'Entendido'
                });
              }
            });
          });
          
          // También validar formularios de familiares
          const familiarForms = document.querySelectorAll('.familiarForm');
          familiarForms.forEach(function(form) {
            form.addEventListener('submit', function(e) {
              const rutInput = this.querySelector('.rut-input');
              if (rutInput && rutInput.value.trim() !== '' && !validarRut(rutInput.value)) {
                e.preventDefault();
                Swal.fire({
                  icon: 'error',
                  title: '¡RUT inválido!',
                  text: 'El RUT ingresado no es válido. Debe tener formato XX.XXX.XXX-X y un dígito verificador correcto.',
                  confirmButtonText: 'Entendido'
                });
              }
            });
          });
          
          // Manejo de modales anidados
          const detalleModals = document.querySelectorAll('[id^="verDetalleModal"]');
          detalleModals.forEach(function(modal) {
            modal.addEventListener('show.bs.modal', function() {
              // Cuando se muestra el modal de detalles, se configuran los botones para abrir modales anidados
              const addFamiliarBtns = this.querySelectorAll('button[data-bs-target^="#agregarFamiliar"]');
              addFamiliarBtns.forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                  e.preventDefault();
                  const targetModalId = this.getAttribute('data-bs-target');
                  const currentModal = bootstrap.Modal.getInstance(modal);
                  currentModal.hide();
                  setTimeout(function() {
                    const targetModal = new bootstrap.Modal(document.querySelector(targetModalId));
                    targetModal.show();
                  }, 500);
                });
              });
            });
          });
        });
      </script>
      <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Manejar correctamente los modales anidados
            const detalleModals = document.querySelectorAll('[id^="verDetalleModal"]');
            
            detalleModals.forEach(function(detalleModal) {
                // Obtener todos los botones que abren modales anidados dentro de este modal de detalles
                const nestedModalButtons = detalleModal.querySelectorAll('[data-bs-toggle="modal"]');
                
                nestedModalButtons.forEach(function(btn) {
                    const targetModalId = btn.getAttribute('data-bs-target');
                    const targetModal = document.querySelector(targetModalId);
                    
                    if (targetModal) {
                        // Cuando se abre el modal anidado, ocultar el modal padre
                        targetModal.addEventListener('show.bs.modal', function() {
                            const detalleModalInstance = bootstrap.Modal.getInstance(detalleModal);
                            if (detalleModalInstance) {
                                // Guardar una referencia al modal padre en el modal hijo
                                targetModal.parentModal = detalleModalInstance;
                                detalleModal.style.display = 'none';
                                // Mantener el fondo oscuro
                                document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                                    backdrop.style.zIndex = '1055';
                                });
                            }
                        });
                        
                        // Cuando se cierra el modal anidado, restaurar el modal padre
                        targetModal.addEventListener('hidden.bs.modal', function() {
                            if (targetModal.parentModal) {
                                detalleModal.style.display = 'block';
                                detalleModal.classList.add('show');
                                // Asegurarse de que el modal padre siga siendo interactivo
                                detalleModal.style.zIndex = '1050';
                            }
                        });
                        
                        // Manejar específicamente los botones de cancelar/cerrar en el modal anidado
                        const closeButtons = targetModal.querySelectorAll('[data-bs-dismiss="modal"], .btn-close, .btn-secondary');
                        closeButtons.forEach(function(closeBtn) {
                            closeBtn.addEventListener('click', function() {
                                const modalInstance = bootstrap.Modal.getInstance(targetModal);
                                if (modalInstance) {
                                    modalInstance.hide();
                                }
                            });
                        });
                    }
                });
            });
            
            // Limpiar los backdrops huérfanos si los hay
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal-backdrop') && !document.querySelector('.modal.show')) {
                    e.target.remove();
                }
            });
        });
      </script>
      
      <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Manejar botones de modales anidados
            document.querySelectorAll('.nested-modal-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const targetModalId = this.getAttribute('data-target-modal');
                    const parentModalId = this.getAttribute('data-parent-modal');
                    
                    const targetModal = document.querySelector(targetModalId);
                    const parentModal = document.querySelector(parentModalId);
                    
                    if (targetModal && parentModal) {
                        // Ocultar el modal padre
                        const parentModalInstance = bootstrap.Modal.getInstance(parentModal);
                        if (parentModalInstance) {
                            parentModalInstance.hide();
                        }
                        
                        // Mostrar el modal hijo después de un breve retraso
                        setTimeout(function() {
                            const targetModalInstance = new bootstrap.Modal(targetModal);
                            targetModalInstance.show();
                            
                            // Guardar referencia al modal padre
                            targetModal.parentModalId = parentModalId;
                        }, 300);
                    }
                });
            });
            
            // Manejar el cierre de modales anidados
            document.querySelectorAll('.modal').forEach(function(modal) {
                modal.addEventListener('hidden.bs.modal', function() {
                    if (this.parentModalId) {
                        setTimeout(function() {
                            const parentModal = document.querySelector(modal.parentModalId);
                            if (parentModal) {
                                const parentModalInstance = new bootstrap.Modal(parentModal);
                                parentModalInstance.show();
                            }
                        }, 300);
                    }
                });
            });
        });
      </script>

      <!-- Modificar el script que maneja la promoción anual -->
        <script>
          document.addEventListener('DOMContentLoaded', function() {
            // Botón para abrir el modal de promoción
            const btnPromocionAnual = document.getElementById('btnPromocionAnual');
            if (btnPromocionAnual) {
              btnPromocionAnual.addEventListener('click', function() {
                // Primero verificar si todos los cursos necesarios existen
                verificarCursosNecesarios();
              });
            }
            
            // Checkbox de confirmación
            const confirmarPromocion = document.getElementById('confirmarPromocion');
            const btnConfirmarPromocion = document.getElementById('btnConfirmarPromocion');
            
            if (confirmarPromocion && btnConfirmarPromocion) {
              confirmarPromocion.addEventListener('change', function() {
                btnConfirmarPromocion.disabled = !this.checked;
              });
            }
            
            // Formulario de promoción
            const formPromocionAnual = document.getElementById('formPromocionAnual');
            if (formPromocionAnual) {
              formPromocionAnual.addEventListener('submit', function(e) {
                if (!confirmarPromocion.checked) {
                  e.preventDefault();
                  Swal.fire({
                    icon: 'error',
                    title: 'Confirmación requerida',
                    text: 'Debe confirmar que entiende que esta acción es irreversible',
                    confirmButtonText: 'Entendido'
                  });
                } else {
                  // Mostrar indicador de carga
                  btnConfirmarPromocion.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Procesando...';
                  btnConfirmarPromocion.disabled = true;
                }
              });
            }
            // Función para verificar los cursos necesarios
            function verificarCursosNecesarios() {
              // Indicador de carga
              Swal.fire({
                title: 'Verificando cursos...',
                text: 'Comprobando si existen todos los cursos necesarios para la promoción',
                allowOutsideClick: false,
                didOpen: () => {
                  Swal.showLoading();
                }
              });
              
              // Crear un formulario para enviar la solicitud de validación
              const formData = new FormData();
              formData.append('validation_only', 'true');
              formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
              
              // Enviar solicitud para verificar cursos
              fetch('{% url "Modulo_admin:promocion_anual" %}', {
                method: 'POST',
                body: formData,
                headers: {
                  'X-Requested-With': 'XMLHttpRequest'
                }
              })
              .then(response => response.json())
              .then(data => {
          if (data.success) {
            // Si todos los cursos existen, mostrar el modal de confirmación
            Swal.close();
            const promocionModal = new bootstrap.Modal(document.getElementById('promocionAnualModal'));
            promocionModal.show();
          } else {
            // Si faltan cursos, mostrar alerta con la lista de cursos necesarios
            let cursosHTML = '<ul class="text-start">';
            data.cursos_necesarios.forEach(curso => {
              cursosHTML += `<li><strong>${curso.nombre}</strong> (${curso.nivel})</li>`;
            });
            cursosHTML += '</ul>';
            
            Swal.fire({
              icon: 'warning',
              title: 'Cursos necesarios no encontrados',
              html: `
                <div>
                  <p>Para realizar la promoción anual, primero debe crear los siguientes cursos:</p>
                  ${cursosHTML}
                  <p class="mt-3">Por favor, cree estos cursos en la sección de <a href="{% url 'Modulo_admin:cursos' %}" class="alert-link">Gestión de Cursos</a> antes de continuar.</p>
                </div>
              `,
              confirmButtonText: 'Entendido',
              showCancelButton: true,
              cancelButtonText: 'Ir a Gestión de Cursos',
            }).then((result) => {
              if (result.dismiss === Swal.DismissReason.cancel) {
                window.location.href = "{% url 'Modulo_admin:cursos' %}";
              }
            });
          }
        })
              .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                  icon: 'error',
                  title: 'Error',
                  text: 'Ocurrió un error al verificar los cursos. Por favor, inténtelo de nuevo.',
                  confirmButtonText: 'Aceptar'
                });
              });
            }
          });
        </script>


        

{% comment %} Validacion para el buscador de Nombre o rut {% endcomment %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const busquedaInput = document.getElementById('busqueda');
    const filtroForm = document.getElementById('filtroForm');
    
    // Función para formatear RUT
    function formatearRut(rut) {
      // Eliminar puntos y guiones
      let valor = rut.replace(/\./g, '').replace(/-/g, '');
  
      // Obtener dígito verificador
      let dv = valor.slice(-1);
  
      // Obtener cuerpo del RUT
      let rutCuerpo = valor.slice(0, -1);
  
      // Formatear RUT con puntos y guión
      let rutFormateado = '';
  
      // Agregar puntos de miles
      for (let i = rutCuerpo.length; i > 0; i -= 3) {
        const inicio = Math.max(0, i - 3);
        rutFormateado = '.' + rutCuerpo.substring(inicio, i) + rutFormateado;
      }
  
      // Eliminar el primer punto
      rutFormateado = rutFormateado.substring(1);
  
      // Agregar guión y dígito verificador
      return rutFormateado + '-' + dv;
    }
  
    // Evento para formatear el RUT mientras se escribe
    if (busquedaInput) {
      busquedaInput.addEventListener('input', function(e) {
        const valor = this.value.trim();
  
        // Si parece ser un RUT (contiene números y posiblemente K/k)
        if (/^[0-9kK]+$/.test(valor.replace(/[^0-9kK]/g, ''))) {
          // Guardar la posición del cursor
          const start = this.selectionStart;
          const end = this.selectionEnd;
          const valorOriginal = this.value;
  
          // Eliminar caracteres no numéricos excepto K/k
          let valorLimpio = this.value.replace(/[^\dkK]/g, '');
  
          // Si hay suficientes caracteres para formatear como RUT
          if (valorLimpio.length > 1) {
            // Formatear el valor
            this.value = formatearRut(valorLimpio);
  
            // Calcular nueva posición del cursor
            const diff = this.value.length - valorOriginal.length;
  
            // Restaurar la posición del cursor
            this.setSelectionRange(start + diff, end + diff);
          }
        }
      });
      
      // Asegurarse de que el RUT esté correctamente formateado al enviar el formulario
      if (filtroForm) {
        filtroForm.addEventListener('submit', function(e) {
          const busquedaValor = busquedaInput.value.trim();
          
          // Si parece ser un RUT, asegurarse de que esté bien formateado
          if (/^[0-9kK.-]+$/.test(busquedaValor) && busquedaValor.length > 1) {
            // Limpiar y reformatear
            const valorLimpio = busquedaValor.replace(/[^\dkK]/g, '');
            if (valorLimpio.length > 1) {
              busquedaInput.value = formatearRut(valorLimpio);
            }
          }
        });
      }
    }
  });
</script>


{% comment %} Verficacion si el rut ingresado es de un alumno egresado {% endcomment %}
<script>
  // Función para verificar si un RUT pertenece a un alumno egresado
  function verificarRutEgresado(rutInput) {
    const rut = rutInput.value.trim();
    if (rut.length > 8) { // Verificar solo si el RUT tiene un formato válido
      fetch(`{% url 'Modulo_admin:verificar_rut_egresado' %}?rut=${encodeURIComponent(rut)}`)
        .then(response => response.json())
        .then(data => {
          // Obtener o crear el contenedor de mensajes
          let msgContainer = rutInput.nextElementSibling;
          if (!msgContainer || !msgContainer.classList.contains('rut-validation-message')) {
            msgContainer = document.createElement('div');
            msgContainer.classList.add('rut-validation-message', 'mt-2');
            rutInput.parentNode.insertBefore(msgContainer, rutInput.nextSibling);
          }
          
          // Mostrar mensaje si es un egresado
          if (data.es_egresado) {
            msgContainer.innerHTML = `
              <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> 
                <strong>Atención:</strong> Este RUT pertenece a ${data.nombre}, 
                alumno egresado en ${data.año_egreso}. No puede ser registrado nuevamente.
              </div>
            `;
            rutInput.classList.add('is-invalid');
            
            // Deshabilitar el botón de envío del formulario
            const submitBtn = rutInput.closest('form').querySelector('button[type="submit"]');
            if (submitBtn) submitBtn.disabled = true;
          } else {
            msgContainer.innerHTML = '';
            rutInput.classList.remove('is-invalid');
            
            // Habilitar el botón de envío del formulario
            const submitBtn = rutInput.closest('form').querySelector('button[type="submit"]');
            if (submitBtn) submitBtn.disabled = false;
          }
        })
        .catch(error => console.error('Error al verificar RUT:', error));
    }
  }
  
  // Aplicar la verificación al campo de RUT en el formulario de registro
  const rutAlumnoRegistro = document.querySelector('#{{ form.rut.id_for_label }}');
  if (rutAlumnoRegistro) {
    rutAlumnoRegistro.addEventListener('blur', function() {
      verificarRutEgresado(this);
    });
  }
</script>



{% comment %} Confirmacion de eliminacion Familiar de Alumno {% endcomment %}
<script>
  function confirmarEliminarFamiliar(alumnoId, familiarNum, nombreFamiliar) {
    Swal.fire({
      title: '¿Eliminar familiar?',
      html: `¿Está seguro que desea eliminar a <strong>${nombreFamiliar}</strong> de la lista de familiares?`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Sí, eliminar',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        // Crear un formulario dinámicamente para enviar la solicitud POST
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `{% url 'Modulo_admin:eliminar_familiar' 0 0 %}`.replace('0/0', `${alumnoId}/${familiarNum}`);
        
        // Agregar el token CSRF
        const csrfToken = document.createElement('input');
        csrfToken.type = 'hidden';
        csrfToken.name = 'csrfmiddlewaretoken';
        csrfToken.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
        form.appendChild(csrfToken);
        
        // Agregar el formulario al documento y enviarlo
        document.body.appendChild(form);
        form.submit();
      }
    });
  }
</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Función para limpiar las "Sombras" que quedan al momento de que se cierra un modal (backdrops)
    function limpiarBackdrops() {
      // Si no hay modales abiertos, eliminar todos los backdrops
      if (!document.querySelector('.modal.show')) {
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
          backdrop.remove();
        });
        // También restaurar el overflow del body
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
      }
    }
    
    // Configurar los formularios de familiares para usar AJAX
    function setupFamiliarForms() {
      document.querySelectorAll('.familiarForm').forEach(function(form) {
        // Remover manejadores de eventos anteriores sin clonar
        const oldSubmitHandler = form._submitHandler;
        if (oldSubmitHandler) {
          form.removeEventListener('submit', oldSubmitHandler);
        }
        
        // Crear nuevo manejador de eventos
        form._submitHandler = function(e) {
          e.preventDefault();
          
          // Obtener el botón de envío y mostrar indicador de carga
          const submitBtn = this.querySelector('button[type="submit"]');
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Procesando...';
          }
          
          // Obtener el ID del alumno y número de familiar
          const actionUrl = this.action;
          const urlParts = actionUrl.split('/');
          const alumnoId = urlParts[urlParts.length - 3]; 
          const familiarNum = urlParts[urlParts.length - 2]; 
          
          console.log("URL de acción:", actionUrl);
          console.log("ID de alumno:", alumnoId);
          console.log("Número de familiar:", familiarNum);
          
          // Enviar el formulario mediante AJAX
          fetch(actionUrl, {
            method: 'POST',
            body: new FormData(this),
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            }
          })
          .then(response => {
            if (!response.ok) {
              throw new Error(`Error HTTP: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            // Restaurar el botón
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.innerHTML = 'Guardar Familiar';
            }
            
            if (data.success) {
              // Cerrar el modal de agregar familiar
              const currentModal = bootstrap.Modal.getInstance(this.closest('.modal'));
              if (currentModal) {
                currentModal.hide();
              }
              
              // Limpiar backdrops huérfanos
              setTimeout(limpiarBackdrops, 100);
              
              // Mostrar mensaje de éxito
              Swal.fire({
                icon: 'success',
                title: 'Éxito',
                text: data.mensaje,
                timer: 1500,
                showConfirmButton: false
              }).then(() => {
                // Actualizar el contenido del modal de detalles sin recargar la página
                actualizarModalDetalles(alumnoId);
              });
            } else {
              // Mostrar errores
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.errores ? data.errores.join('\n') : 'Ocurrió un error al procesar el formulario',
                confirmButtonText: 'Entendido'
              });
            }
          })
          .catch(error => {
            console.error('Error:', error);
            
            // Restaurar el botón
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.innerHTML = 'Guardar Familiar';
            }
            
            // Mostrar error
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'Ocurrió un error al procesar la solicitud. Por favor, inténtelo de nuevo.',
              confirmButtonText: 'Entendido'
            });
          });
        };
        
        // Agregar el nuevo manejador
        form.addEventListener('submit', form._submitHandler);
      });
    }
    
    // Función para actualizar el contenido del modal de detalles
    function actualizarModalDetalles(alumnoId) {
      // Realizar una solicitud AJAX para obtener los datos actualizados del alumno
      fetch(`{% url 'Modulo_admin:obtener_datos_alumno' 0 %}`.replace('0', alumnoId), {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          // Abrir el modal de detalles
          const detalleModal = document.getElementById(`verDetalleModal${alumnoId}`);
          if (!detalleModal) {
            console.error(`Modal de detalles no encontrado para alumno ID: ${alumnoId}`);
            return;
          }
          
          // Actualizar el contenido del modal con los nuevos datos
          const familiar1Container = detalleModal.querySelector('.familiar-1-container');
          const familiar2Container = detalleModal.querySelector('.familiar-2-container');
          
          if (!familiar1Container || !familiar2Container) {
            console.error('Contenedores de familiares no encontrados');
            return;
          }
          
          if (data.alumno.familiar_1) {
            // Actualizar o crear el contenido del familiar 1
            familiar1Container.innerHTML = `
              <div class="card mb-3">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start">
                    <h6 class="card-subtitle text-muted">Familiar 1</h6>
                    ${data.is_superuser ? `
                    <button type="button" class="btn btn-sm btn-danger" 
                      onclick="confirmarEliminarFamiliar('${alumnoId}', 1, '${data.alumno.familiar_1}')">
                      Eliminar  
                    </button>
                    ` : ''}
                  </div>
                  <p><strong>Nombre:</strong> ${data.alumno.familiar_1}</p>
                  <p><strong>RUT:</strong> ${data.alumno.rut_familiar_1 || "No registrado"}</p>
                  <p><strong>Relación:</strong> ${data.alumno.familiar_1_relacion || "No especificada"}</p>
                  <p><strong>Teléfono:</strong> ${data.alumno.familiar_1_telefono || "No registrado"}</p>
                </div>
              </div>
            `;
          } else {
            // Mostrar botón para agregar familiar 1
            familiar1Container.innerHTML = `
              <div class="mb-3">
                <button type="button" class="btn btn-sm btn-success nested-modal-btn" 
                  data-target-modal="#agregarFamiliar1Modal${alumnoId}"
                  data-parent-modal="#verDetalleModal${alumnoId}"
                  data-bs-backdrop="static">
                    + Añadir Familiar 1
                </button>
              </div>
            `;
          }
          
          if (data.alumno.familiar_2) {
            // Actualizar o crear el contenido del familiar 2
            familiar2Container.innerHTML = `
              <div class="card">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start">
                    <h6 class="card-subtitle mb-2 text-muted">Familiar 2</h6>
                    ${data.is_superuser ? `
                    <button type="button" class="btn btn-sm btn-danger" 
                      onclick="confirmarEliminarFamiliar('${alumnoId}', 2, '${data.alumno.familiar_2}')">
                      Eliminar  
                    </button>
                    ` : ''}
                  </div>
                  <p><strong>Nombre:</strong> ${data.alumno.familiar_2}</p>
                  <p><strong>RUT:</strong> ${data.alumno.rut_familiar_2 || "No registrado"}</p>
                  <p><strong>Relación:</strong> ${data.alumno.familiar_2_relacion || "No especificada"}</p>
                  <p><strong>Teléfono:</strong> ${data.alumno.familiar_2_telefono || "No registrado"}</p>
                </div>
              </div>
            `;
          } else if (data.alumno.familiar_1) {
            // Mostrar botón para agregar familiar 2
            familiar2Container.innerHTML = `
              <div>
                <button type="button" class="btn btn-sm btn-success nested-modal-btn" 
                      data-target-modal="#agregarFamiliar2Modal${alumnoId}"
                      data-parent-modal="#verDetalleModal${alumnoId}"
                      data-bs-backdrop="static">
                  + Añadir Familiar 2
                </button>
              </div>
            `;
          } else {
            familiar2Container.innerHTML = '';
          }
          
          // Limpiar backdrops huérfanos
          limpiarBackdrops();
          
          // Mostrar el modal de detalles actualizado
          const modalInstance = bootstrap.Modal.getInstance(detalleModal);
          if (modalInstance) {
            // Si el modal esta abierto, no hay necesidad de abrirlo nuevamente
          } else {
            // Si no, se abre el modal
            const newModalInstance = new bootstrap.Modal(detalleModal);
            newModalInstance.show();
          }
          
          // Volver a configurar los botones de modales anidados
          setupNestedModalButtons();
        } else {
          console.error('Error al obtener datos del alumno:', data.mensaje);
        }
      })
      .catch(error => {
        console.error('Error en la solicitud AJAX:', error);
      });
    }
    
    // Configurar botones de modales anidados
    function setupNestedModalButtons() {
      document.querySelectorAll('.nested-modal-btn').forEach(function(btn) {
        // Remover manejadores de eventos anteriores
        const oldClickHandler = btn._clickHandler;
        if (oldClickHandler) {
          btn.removeEventListener('click', oldClickHandler);
        }
        
        // Crear nuevo manejador de eventos
        btn._clickHandler = function() {
          const targetModalId = this.getAttribute('data-target-modal');
          const parentModalId = this.getAttribute('data-parent-modal');
          
          const targetModal = document.querySelector(targetModalId);
          const parentModal = document.querySelector(parentModalId);
          
          if (targetModal && parentModal) {
            // Ocultar el modal padre
            const parentModalInstance = bootstrap.Modal.getInstance(parentModal);
            if (parentModalInstance) {
              parentModalInstance.hide();
            }
            
            // Limpiar backdrops huérfanos
            setTimeout(limpiarBackdrops, 100);
            
            // Mostrar el modal hijo después de un breve retraso
            setTimeout(function() {
              const targetModalInstance = new bootstrap.Modal(targetModal);
              targetModalInstance.show();
              
              // Guardar referencia al modal padre
              targetModal.parentModalId = parentModalId;
            }, 300);
          }
        };
        
        // Agregar el nuevo manejador
        btn.addEventListener('click', btn._clickHandler);
      });
    }
    
    // Variable para rastrear si ya se configuraron los manejadores
    let handlersInitialized = false;
    
    // Inicializar los manejadores solo una vez
    if (!handlersInitialized) {
      setupFamiliarForms();
      setupNestedModalButtons();
      handlersInitialized = true;
    }
    
    // También configurar para modales que se abren dinámicamente
    document.body.addEventListener('shown.bs.modal', function(event) {
      setupFamiliarForms();
      setupNestedModalButtons();
    });
    
    // Agregar manejador para limpiar backdrops cuando se cierra un modal
    document.body.addEventListener('hidden.bs.modal', function(event) {
      setTimeout(limpiarBackdrops, 100);
    });
    
    // Agregar manejador global para clicks en el documento
    document.addEventListener('click', function(e) {
      // Si se hace clic en un backdrop y no hay modales abiertos, eliminarlo
      if (e.target.classList.contains('modal-backdrop') && !document.querySelector('.modal.show')) {
        e.target.remove();
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
      }
    });
    
    // Configurar la eliminación de familiares
    window.confirmarEliminarFamiliar = function(alumnoId, familiarNum, nombreFamiliar) {
      Swal.fire({
        title: '¿Eliminar familiar?',
        html: `¿Está seguro que desea eliminar a <strong>${nombreFamiliar}</strong> de la lista de familiares?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) {
          //Indicador de carga
          Swal.fire({
            title: 'Procesando...',
            text: 'Eliminando familiar',
            allowOutsideClick: false,
            didOpen: () => {
              Swal.showLoading();
            }
          });
          
          // Crear FormData para la solicitud
          const formData = new FormData();
          formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
          
          // Enviar solicitud AJAX
          fetch(`{% url 'Modulo_admin:eliminar_familiar' 0 0 %}`.replace('0/0', `${alumnoId}/${familiarNum}`), {
            method: 'POST',
            body: formData,
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            }
          })
          .then(response => {
            if (!response.ok) {
              throw new Error(`Error HTTP: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            if (data.success) {
              // Mostrar mensaje de éxito
              Swal.fire({
                icon: 'success',
                title: 'Éxito',
                text: data.mensaje,
                timer: 1500,
                showConfirmButton: false
              }).then(() => {
                // Limpiar backdrops huérfanos
                limpiarBackdrops();
                
                // Actualizar el contenido del modal de detalles
                actualizarModalDetalles(alumnoId);
              });
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.mensaje || 'Ocurrió un error al eliminar el familiar',
                confirmButtonText: 'Entendido'
              });
            }
          })
          .catch(error => {
            console.error('Error:', error);
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'Ocurrió un error al procesar la solicitud',
              confirmButtonText: 'Entendido'
            });
          });
        }
      });
    };
  });
</script>

    
{% endblock %}