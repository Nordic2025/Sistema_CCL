{% extends 'base_admin.html' %}

{% load static %}

{% block title %}Grafico de Retiros{% endblock %}

{% block content %}
<div class="container main-content" style="margin-bottom: 30px;">
    <div class="d-flex justify-content-between align-items-center flex-wrap" style="margin-top: 30px; margin-bottom: 20px;">
        <h1 style="font-size: 2rem;">Panel de Administrador | Retiros de Estudiantes</h1>
        
        <div class="d-flex align-items-center gap-3">
            <!-- Filtros de cursos en línea -->
            <div class="dropdown">
                <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-filter me-1"></i> Filtrar por curso
                </button>
                <div class="dropdown-menu p-3" aria-labelledby="dropdownMenuButton" style="min-width: 500px; max-width: 90vw;">
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6 class="dropdown-header px-0">Pre-Básica</h6>
                            <div class="d-flex justify-content-between align-items-start">
                                <div id="filtro-prebasica" class="d-flex flex-wrap gap-1 mb-2" style="width: 85%;">
                                    <!-- Botones de cursos de Pre-Básica -->
                                </div>
                                <button class="btn btn-sm btn-outline-danger" onclick="deseleccionarNivel('prebasica')" style="white-space: nowrap;">
                                    <i class="fas fa-times-circle me-1"></i> Deseleccionar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6 class="dropdown-header px-0">Básica</h6>
                            <div class="d-flex justify-content-between align-items-start">
                                <div id="filtro-basica" class="d-flex flex-wrap gap-1 mb-2" style="width: 85%;">
                                    <!-- Botones de cursos de Básica -->
                                </div>
                                <button class="btn btn-sm btn-outline-danger" onclick="deseleccionarNivel('basica')" style="white-space: nowrap;">
                                    <i class="fas fa-times-circle me-1"></i> Deseleccionar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6 class="dropdown-header px-0">Media</h6>
                            <div class="d-flex justify-content-between align-items-start">
                                <div id="filtro-media" class="d-flex flex-wrap gap-1 mb-2" style="width: 85%;">
                                    <!-- Botones de cursos de Media -->
                                </div>
                                <button class="btn btn-sm btn-outline-danger" onclick="deseleccionarNivel('media')" style="white-space: nowrap;">
                                    <i class="fas fa-times-circle me-1"></i> Deseleccionar
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="dropdown-divider"></div>
                    <button id="reset-filtro" class="btn btn-sm btn-outline-secondary w-100">
                        <i class="fas fa-sync-alt me-1"></i> Mostrar todos
                    </button>
                </div>
            </div>
            
            <!-- Filtro por fecha -->
            <div class="dropdown">
                <button class="btn btn-info dropdown-toggle" type="button" id="dropdownFechaButton" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-calendar-alt me-1"></i> Filtrar por fecha
                </button>
                <div class="dropdown-menu p-3" aria-labelledby="dropdownFechaButton" style="min-width: 300px;">
                    <div class="mb-3">
                        <label for="fecha-inicio" class="form-label">Desde:</label>
                        <input type="date" class="form-control" id="fecha-inicio">
                    </div>
                    <div class="mb-3">
                        <label for="fecha-fin" class="form-label">Hasta:</label>
                        <input type="date" class="form-control" id="fecha-fin">
                    </div>
                    <button id="aplicar-filtro-fecha" class="btn btn-sm btn-primary w-100">
                        <i class="fas fa-check me-1"></i> Aplicar filtro
                    </button>
                </div>
            </div>
            
            <!-- Botón generar reporte -->
            <button id="generar-reporte" class="btn btn-success">
                <i class="fas fa-file-pdf me-1"></i> Generar Reporte
            </button>
        </div>
    </div>
    
    <div class="container-fluid">
        <div class="row">
            <!-- Gráfico principal por nivel educativo -->
            <div class="col-md-12 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h3 class="card-title">Retiros por Nivel Educativo</h3>
                    </div>
                    <div class="card-body">
                        <div id="grafico-nivel" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
                    </div>
                </div>
            </div>
            
            <!-- Gráfico de retiros por curso -->
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h3 class="card-title">Retiros por Curso</h3>
                    </div>
                    <div class="card-body">
                        <div id="grafico-curso" style="min-width: 310px; height: 350px; margin: 0 auto"></div>
                    </div>
                </div>
            </div>
            
            <!-- Gráfico de motivos de retiro -->
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h3 class="card-title">Motivos de Retiro</h3>
                    </div>
                    <div class="card-body">
                        <div id="grafico-motivos" style="min-width: 310px; height: 350px; margin: 0 auto"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% comment %}
    Script para generar gráficos
{% endcomment %}

<script>

    let actualizarGraficosGlobal;

    document.addEventListener('DOMContentLoaded', function() {
        // Datos de retiros desde el backend
        const datosRetiros = {{ datos_retiros|default:"{}"|safe }};
        const cursos = {{ cursos|default:"[]"|safe }};

        //Logs para verficar el correcto recibimiento de los datos
        console.log('Datos de retiros recibidos del backend:', datosRetiros);
        console.log('Estructura de datos por curso:', datosRetiros.por_curso);
        
        console.log("Datos de retiros:", datosRetiros);
        console.log("Cursos disponibles:", cursos);
        
        // Clasificación de cursos por nivel
        const cursosPorNivel = {
            'Pre-Básica': [],
            'Básica': [],
            'Media': []
        };
        
        window.deseleccionarNivel = function(nivel) {
            // Obtener el contenedor del nivel
            const contenedor = document.getElementById(`filtro-${nivel}`);
            if (!contenedor) return;
            
            // Obtener todos los botones de curso en este nivel
            const botones = contenedor.querySelectorAll('.curso-btn');
            
            // Deseleccionar todos los botones de este nivel
            botones.forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-primary');
            });
            
            // Recopilar todos los cursos que siguen seleccionados después de la deselección
            const cursosSeleccionados = Array.from(
                document.querySelectorAll('.curso-btn.btn-primary')
            ).map(btn => btn.dataset.curso);
            
            console.log('Cursos que siguen seleccionados:', cursosSeleccionados);
            
            // Actualizar los gráficos con los cursos que quedan seleccionados
            actualizarGraficos(cursosSeleccionados);
            
            // Actualizar el estado del botón de limpiar filtros si existe
            if (typeof actualizarBotonLimpiarFiltros === 'function') {
                // Convertir el array a Set para mantener la compatibilidad con la función original
                const cursosSet = new Set(cursosSeleccionados);
                actualizarBotonLimpiarFiltros(cursosSet);
            }
        };

        // Función para clasificar un curso en su nivel educativo
        function clasificarCurso(curso) {
            // Normalizar el texto (quitar acentos, convertir a minúsculas)
            const cursoNormalizado = curso.toLowerCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            
            // Verificar nivel Pre-Básica
            if (cursoNormalizado.includes('pre-kinder') || 
                cursoNormalizado.includes('prekinder') || 
                cursoNormalizado.includes('kinder')) {
                return 'Pre-Básica';
            }
            
            // Verificar nivel Media (verificar primero Media para evitar confusiones)
            if (cursoNormalizado.includes('medio') || 
                cursoNormalizado.includes('media') ||
                /^[i-iv]°?\s?[a-d]$/i.test(cursoNormalizado) ||
                /^[1-4]°?\s?medio/i.test(cursoNormalizado)) {
                return 'Media';
            }
            
            // Verificar nivel Básica
            if (cursoNormalizado.includes('basico') || 
                cursoNormalizado.includes('básico') ||
                /^\d°\s?[a-d]$/i.test(cursoNormalizado) ||
                /^[1-8]°/.test(cursoNormalizado)) {
                return 'Básica';
            }
            
            // Si no se puede determinar, verificar por el número
            const match = curso.match(/^(\d+)°/);
            if (match) {
                const numero = parseInt(match[1]);
                if (numero >= 1 && numero <= 8) {
                    return 'Básica';
                } else if (numero >= 1 && numero <= 4) {
                    // Verificar si tiene "medio" en el nombre
                    if (cursoNormalizado.includes('medio')) {
                        return 'Media';
                    }
                    return 'Básica'; // Por defecto, asumir básica
                }
            }
            
            console.warn('No se pudo clasificar el curso:', curso);
            return 'Media'; // Valor por defecto
        }
        
        // Función para generar botones de filtro
        function generarBotonesFiltro() {
            const filtroPrebasica = document.getElementById('filtro-prebasica');
            const filtroBasica = document.getElementById('filtro-basica');
            const filtroMedia = document.getElementById('filtro-media');
            
            // Limpiar contenedores
            filtroPrebasica.innerHTML = '';
            filtroBasica.innerHTML = '';
            filtroMedia.innerHTML = '';
            
            // Clasificar los cursos por nivel
            cursosPorNivel = {
                'Pre-Básica': [],
                'Básica': [],
                'Media': []
            };
            
            // Reclasificar todos los cursos
            cursos.forEach(curso => {
                const nivel = clasificarCurso(curso);
                cursosPorNivel[nivel].push(curso);
            });
            
            // Ordenar los cursos en cada nivel
            Object.keys(cursosPorNivel).forEach(nivel => {
                cursosPorNivel[nivel] = ordenarCursos(cursosPorNivel[nivel]);
            });
            
            console.log('Cursos clasificados por nivel:', cursosPorNivel);
            
            // Conjunto para almacenar los cursos seleccionados
            const cursosSeleccionados = new Set(cursos);
            
            // Función para crear botón de filtro
            function crearBotonFiltro(curso, contenedor) {
                const btn = document.createElement('button');
                btn.textContent = curso;
                btn.className = 'btn btn-sm btn-primary curso-btn';
                btn.dataset.curso = curso;
                btn.style.marginRight = '5px';
                btn.style.marginBottom = '5px';
                
                // Evento al hacer clic en un botón de curso
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const cursoSel = this.dataset.curso;
                    
                    if (cursosSeleccionados.has(cursoSel)) {
                        // Desactivar este curso
                        cursosSeleccionados.delete(cursoSel);
                        this.classList.remove('btn-primary');
                        this.classList.add('btn-outline-primary');
                    } else {
                        // Activar este curso
                        cursosSeleccionados.add(cursoSel);
                        this.classList.remove('btn-outline-primary');
                        this.classList.add('btn-primary');
                    }
                    
                    actualizarGraficos(Array.from(cursosSeleccionados));
                    actualizarBotonLimpiarFiltros(cursosSeleccionados);
                });
                
                contenedor.appendChild(btn);
            }
            
            // Función para crear botón de deseleccionar nivel
            function crearBotonDeseleccionarNivel(nivel, contenedor) {
                const btn = document.createElement('button');
                btn.textContent = `Deseleccionar ${nivel}`;
                btn.className = 'btn btn-sm btn-outline-danger deseleccionar-nivel-btn w-100 mb-2';
                btn.dataset.nivel = nivel;
                
                // Evento al hacer clic en el botón de deseleccionar nivel
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const nivelSel = this.dataset.nivel;
                    
                    // Deseleccionar todos los cursos de este nivel
                    cursosPorNivel[nivelSel].forEach(curso => {
                        cursosSeleccionados.delete(curso);
                        const cursoBtn = document.querySelector(`.curso-btn[data-curso="${curso}"]`);
                        if (cursoBtn) {
                            cursoBtn.classList.remove('btn-primary');
                            cursoBtn.classList.add('btn-outline-primary');
                        }
                    });
                    
                    actualizarGraficos(Array.from(cursosSeleccionados));
                    actualizarBotonLimpiarFiltros(cursosSeleccionados);
                });
                
                contenedor.appendChild(btn);
            }
            
            // Crear botones para deseleccionar nivel
            crearBotonDeseleccionarNivel('Pre-Básica', filtroPrebasica);
            
            // Crear botones para cada curso de Pre-Básica
            cursosPorNivel['Pre-Básica'].forEach(curso => {
                crearBotonFiltro(curso, filtroPrebasica);
            });
            
            // Crear botón para deseleccionar Básica
            crearBotonDeseleccionarNivel('Básica', filtroBasica);
            
            // Crear botones para cada curso de Básica
            cursosPorNivel['Básica'].forEach(curso => {
                crearBotonFiltro(curso, filtroBasica);
            });
            
            // Crear botón para deseleccionar Media
            crearBotonDeseleccionarNivel('Media', filtroMedia);
            
            // Crear botones para cada curso de Media
            cursosPorNivel['Media'].forEach(curso => {
                crearBotonFiltro(curso, filtroMedia);
            });
            
            // Inicializar el botón de limpiar filtros
            actualizarBotonLimpiarFiltros(cursosSeleccionados);
        }
        
        // Función para actualizar el botón de limpiar filtros
        function actualizarBotonLimpiarFiltros(cursosSeleccionados) {
            // Verificar si ya existe el botón
            let limpiarFiltrosBtn = document.getElementById('limpiar-filtros-btn');
            
            // Si no hay filtros activos (todos los cursos están seleccionados)
            if (cursosSeleccionados.size === cursos.length) {
                // Si el botón existe, ocultarlo
                if (limpiarFiltrosBtn) {
                    limpiarFiltrosBtn.style.display = 'none';
                }
                return;
            }
            
            // Si hay filtros activos y el botón no existe, crearlo
            if (!limpiarFiltrosBtn) {
                limpiarFiltrosBtn = document.createElement('button');
                limpiarFiltrosBtn.id = 'limpiar-filtros-btn';
                limpiarFiltrosBtn.className = 'btn btn-warning';
                limpiarFiltrosBtn.innerHTML = '<i class="fas fa-broom me-1"></i> Limpiar filtros';
                
                // Evento al hacer clic en el botón de limpiar filtros
                limpiarFiltrosBtn.addEventListener('click', function() {
                    // Restablecer todos los cursos
                    const cursosSeleccionados = new Set(cursos);
                    
                    // Actualizar apariencia de botones
                    document.querySelectorAll('.curso-btn').forEach(btn => {
                        btn.classList.remove('btn-outline-primary');
                        btn.classList.add('btn-primary');
                    });
                    
                    actualizarGraficos(Array.from(cursosSeleccionados));
                    actualizarBotonLimpiarFiltros(cursosSeleccionados);
                });
                
                // Agregar el botón después del botón de generar reporte
                const generarReporteBtn = document.getElementById('generar-reporte');
                generarReporteBtn.parentNode.insertBefore(limpiarFiltrosBtn, generarReporteBtn.nextSibling);
            } else {
                // Si el botón ya existe, mostrarlo
                limpiarFiltrosBtn.style.display = 'block';
            }
        }
        
        // Botón para resetear filtros
        document.getElementById('reset-filtro').addEventListener('click', function(e) {
            e.stopPropagation();
            
            // Restablecer todos los cursos
            const cursosSeleccionados = new Set(cursos);
            
            // Actualizar apariencia de botones
            document.querySelectorAll('.curso-btn').forEach(btn => {
                btn.classList.remove('btn-outline-primary');
                btn.classList.add('btn-primary');
            });
            
            actualizarGraficos(Array.from(cursosSeleccionados));
            actualizarBotonLimpiarFiltros(cursosSeleccionados);
        });
        
        
        
        
        
        
        // Clasificar los cursos por nivel
        cursos.forEach(curso => {
            const nivel = clasificarCurso(curso);
            cursosPorNivel[nivel].push(curso);
        });
        
        // Ordenar los cursos dentro de cada nivel
        function ordenarCursos(cursos) {
            return cursos.sort((a, b) => {
                // Función para extraer el número del curso
                const getNumero = (curso) => {
                    const match = curso.match(/(\d+)/);
                    return match ? parseInt(match[0]) : 0;
                };
                
                // Función para extraer la letra del curso
                const getLetra = (curso) => {
                    const match = curso.match(/[A-D]$/);
                    return match ? match[0] : 'Z';
                };
                
                // Primero ordenar por número
                const numA = getNumero(a);
                const numB = getNumero(b);
                
                if (numA !== numB) {
                    return numA - numB;
                }
                
                // Si los números son iguales, ordenar por letra
                return getLetra(a).localeCompare(getLetra(b));
            });
        }
        
        // Ordenar los cursos en cada nivel
        Object.keys(cursosPorNivel).forEach(nivel => {
            cursosPorNivel[nivel] = ordenarCursos(cursosPorNivel[nivel]);
        });
        
        function generarBotonesFiltro() {
            const filtroPrebasica = document.getElementById('filtro-prebasica');
            const filtroBasica = document.getElementById('filtro-basica');
            const filtroMedia = document.getElementById('filtro-media');
            
            // Limpiar contenedores
            filtroPrebasica.innerHTML = '';
            filtroBasica.innerHTML = '';
            filtroMedia.innerHTML = '';
            
            // Clasificar los cursos por nivel
            cursosPorNivel['Pre-Básica'] = [];
            cursosPorNivel['Básica'] = [];
            cursosPorNivel['Media'] = [];
            
            // Reclasificar todos los cursos
            cursos.forEach(curso => {
                const nivel = clasificarCurso(curso);
                cursosPorNivel[nivel].push(curso);
            });
            
            // Ordenar los cursos en cada nivel
            Object.keys(cursosPorNivel).forEach(nivel => {
                cursosPorNivel[nivel] = ordenarCursos(cursosPorNivel[nivel]);
            });
            
            console.log('Cursos clasificados por nivel:', cursosPorNivel);
            
            // Conjunto para almacenar los cursos seleccionados
            const cursosSeleccionados = new Set(cursos);
            
            // Función para crear botón de filtro
            function crearBotonFiltro(curso, contenedor) {
                const btn = document.createElement('button');
                btn.textContent = curso;
                btn.className = 'btn btn-sm btn-primary curso-btn';
                btn.dataset.curso = curso;
                btn.style.marginRight = '5px';
                btn.style.marginBottom = '5px';
                
                // Evento al hacer clic en un botón de curso
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const cursoSel = this.dataset.curso;
                    
                    if (cursosSeleccionados.has(cursoSel)) {
                        // Desactivar este curso
                        cursosSeleccionados.delete(cursoSel);
                        this.classList.remove('btn-primary');
                        this.classList.add('btn-outline-primary');
                    } else {
                        // Activar este curso
                        cursosSeleccionados.add(cursoSel);
                        this.classList.remove('btn-outline-primary');
                        this.classList.add('btn-primary');
                    }
                    
                    actualizarGraficos(Array.from(cursosSeleccionados));
                });
                
                contenedor.appendChild(btn);
            }
            
            // Crear botones para cada nivel
            cursosPorNivel['Pre-Básica'].forEach(curso => {
                crearBotonFiltro(curso, filtroPrebasica);
            });
            
            cursosPorNivel['Básica'].forEach(curso => {
                crearBotonFiltro(curso, filtroBasica);
            });
            
            cursosPorNivel['Media'].forEach(curso => {
                crearBotonFiltro(curso, filtroMedia);
            });
        }
        
        // Llamar a la función para generar los botones
        generarBotonesFiltro();
        
        // Botón para resetear filtros
        document.getElementById('reset-filtro').addEventListener('click', function(e) {
            e.stopPropagation();
            
            // Restablecer todos los cursos
            const cursosSeleccionados = new Set(cursos);
            
            // Actualizar apariencia de botones
            document.querySelectorAll('.curso-btn').forEach(btn => {
                btn.classList.remove('btn-outline-primary');
                btn.classList.add('btn-primary');
            });
            actualizarGraficos(Array.from(cursosSeleccionados));
        });
        
        // Filtro por fecha
        document.getElementById('aplicar-filtro-fecha').addEventListener('click', function() {
            const fechaInicio = document.getElementById('fecha-inicio').value;
            const fechaFin = document.getElementById('fecha-fin').value;
            
            // Redirigir a la misma página con parámetros de filtro
            const url = new URL(window.location.href);
            url.searchParams.set('fecha_inicio', fechaInicio);
            url.searchParams.set('fecha_fin', fechaFin);
            
            // Obtener cursos seleccionados
            const cursosSeleccionados = Array.from(
                document.querySelectorAll('.curso-btn.btn-primary')
            ).map(btn => btn.dataset.curso);
            
            // Si hay cursos seleccionados, agregarlos como parámetro
            if (cursosSeleccionados.length < cursos.length) {
                url.searchParams.set('cursos', cursosSeleccionados.join(','));
            } else {
                url.searchParams.delete('cursos');
            }
            
            window.location.href = url.toString();
        });
        
        // Función para contar retiros por nivel educativo
        function contarRetirosPorNivel(cursosSeleccionados) {
            // Inicializar contadores por nivel
            const niveles = {
                'Pre-Básica': 0,
                'Básica': 0,
                'Media': 0
            };
            
            // Si tenemos datos del backend
            if (datosRetiros && datosRetiros.por_curso) {
                console.log('Datos por curso disponibles:', datosRetiros.por_curso);
                
                // Solo contar los cursos que están seleccionados
                cursosSeleccionados.forEach(curso => {
                    // Buscar coincidencias parciales en los nombres de curso
                    Object.keys(datosRetiros.por_curso).forEach(cursoCompleto => {
                        if (cursoCompleto.includes(curso)) {
                            const nivel = clasificarCurso(curso);
                            niveles[nivel] += datosRetiros.por_curso[cursoCompleto];
                            console.log(`Coincidencia: Curso seleccionado "${curso}" con curso completo "${cursoCompleto}", Nivel: ${nivel}, Retiros: ${datosRetiros.por_curso[cursoCompleto]}`);
                        }
                    });
                });
                
                console.log('Niveles calculados:', niveles);
                return niveles;
            }
            
            // Si no hay datos, devolver valores por defecto
            return niveles;
        }
        
        // Función para contar retiros por curso
        function contarRetirosPorCurso(cursosSeleccionados) {
            // Inicializar objeto para almacenar los conteos
            const resultado = {};
            
            // Si tenemos datos del backend
            if (datosRetiros && datosRetiros.por_curso) {
                console.log('Procesando datos por curso:', datosRetiros.por_curso);
                
                // Inicializar todos los cursos seleccionados con 0
                cursosSeleccionados.forEach(curso => {
                    resultado[curso] = 0;
                });
                
                // Buscar coincidencias parciales para cada curso seleccionado
                cursosSeleccionados.forEach(curso => {
                    Object.keys(datosRetiros.por_curso).forEach(cursoCompleto => {
                        if (cursoCompleto.includes(curso)) {
                            resultado[curso] += datosRetiros.por_curso[cursoCompleto];
                            console.log(`Coincidencia: Curso seleccionado "${curso}" con curso completo "${cursoCompleto}", Retiros: ${datosRetiros.por_curso[cursoCompleto]}`);
                        }
                    });
                });
                
                console.log('Resultado procesado:', resultado);
                return resultado;
            }
            
            // Si no hay datos, devolver un objeto con todos los cursos en 0
            cursosSeleccionados.forEach(curso => {
                resultado[curso] = 0;
            });
            
            return resultado;
        }
        
        // Función para actualizar todos los gráficos
        function actualizarGraficos(cursosSeleccionados) {
            console.log('Actualizando gráficos con cursos seleccionados:', cursosSeleccionados);
            
            try {
                // Obtener datos filtrados
                const datosPorNivel = contarRetirosPorNivel(cursosSeleccionados);
                console.log('Datos por nivel después de filtrar:', datosPorNivel);
                
                const datosPorCurso = contarRetirosPorCurso(cursosSeleccionados);
                const datosPorMotivo = contarRetirosPorMotivo(cursosSeleccionados);
                
                // Actualizar gráfico por nivel
                actualizarGraficoNivel(datosPorNivel);
                
                // Actualizar gráfico por curso
                actualizarGraficoCurso(datosPorCurso);
                
                // Actualizar gráfico por motivo
                actualizarGraficoMotivos(datosPorMotivo);
                
                // Actualizar título según filtros
                let titulo = 'Retiros de Estudiantes';
                if (cursosSeleccionados.length < cursos.length) {
                    titulo += ' - Cursos seleccionados: ' + cursosSeleccionados.length;
                }
                // Obtener fechas de los parámetros de URL
                const urlParams = new URLSearchParams(window.location.search);
                const fechaInicio = urlParams.get('fecha_inicio');
                const fechaFin = urlParams.get('fecha_fin');
                
                if (fechaInicio && fechaFin) {
                    titulo += ` (${fechaInicio} al ${fechaFin})`;
                }
                
                // Actualizar títulos de los gráficos
                if (chartNivel) {
                    chartNivel.setTitle({ text: `Retiros por Nivel Educativo - ${titulo}` });
                }
                if (chartCurso) {
                    chartCurso.setTitle({ text: `Retiros por Curso - ${titulo}` });
                }
                if (chartMotivos) {
                    chartMotivos.setTitle({ text: `Motivos de Retiro - ${titulo}` });
                }
            } catch (error) {
                console.error('Error al actualizar los gráficos:', error);
            }
        }
            

        
        // Función para contar retiros por motivo
        function contarRetirosPorMotivo(cursosSeleccionados) {
            // Si tenemos datos del backend, los usamos
            if (datosRetiros && datosRetiros.por_motivo) {
                
                return datosRetiros.por_motivo;
            }
            
            // Si no hay datos, devolver valores por defecto
            return {
                'Asuntos Médicos': 0,
                'Asuntos Familiares': 0,
                'Motivos Personales': 0,
                'Prefiero no decirlo': 0
            };
        }

        function contarRetirosPorCurso(cursosSeleccionados) {
            // Inicializar objeto para almacenar los conteos
            const resultado = {};
            
            // Si tenemos datos del backend
            if (datosRetiros && datosRetiros.por_curso) {
                console.log('Procesando datos por curso:', datosRetiros.por_curso);
                
                // Iterar sobre todos los cursos en datosRetiros.por_curso
                Object.keys(datosRetiros.por_curso).forEach(cursoCompleto => {
                    // Extraer el nombre del curso sin el sufijo "- Básica" o "- Media"
                    let cursoNombre = cursoCompleto;
                    if (cursoCompleto.includes(' - ')) {
                        cursoNombre = cursoCompleto.split(' - ')[0];
                    }
                    
                    console.log(`Curso completo: ${cursoCompleto}, Curso nombre: ${cursoNombre}, Retiros: ${datosRetiros.por_curso[cursoCompleto]}`);
                    
                    // Verificar si este curso está en los seleccionados
                    if (cursosSeleccionados.includes(cursoNombre)) {
                        resultado[cursoNombre] = datosRetiros.por_curso[cursoCompleto];
                    }
                });
                
                // Para los cursos seleccionados que no tienen retiros, asignar 0
                cursosSeleccionados.forEach(curso => {
                    if (resultado[curso] === undefined) {
                        resultado[curso] = 0;
                    }
                });
                
                console.log('Resultado procesado:', resultado);
                return resultado;
            }
            
            // Si no hay datos, devolver un objeto con todos los cursos en 0
            cursosSeleccionados.forEach(curso => {
                resultado[curso] = 0;
            });
            
            return resultado;
        }

        // Función para actualizar todos los gráficos
        function actualizarGraficos(cursosSeleccionados) {
            console.log('Actualizando gráficos con cursos seleccionados:', cursosSeleccionados);
            
            // Obtener datos filtrados
            const datosPorNivel = contarRetirosPorNivel(cursosSeleccionados);
            console.log('Datos por nivel después de filtrar:', datosPorNivel);
            
            const datosPorCurso = contarRetirosPorCurso(cursosSeleccionados);
            const datosPorMotivo = contarRetirosPorMotivo(cursosSeleccionados);
            
            // Actualizar gráfico por nivel
            actualizarGraficoNivel(datosPorNivel);
            
            // Actualizar gráfico por curso
            actualizarGraficoCurso(datosPorCurso);
            
            // Actualizar gráfico por motivo
            actualizarGraficoMotivos(datosPorMotivo);
            
            // Actualizar título según filtros
            let titulo = 'Retiros de Estudiantes';
            if (cursosSeleccionados.length < cursos.length) {
                titulo += ' - Cursos seleccionados: ' + cursosSeleccionados.length;
            }
            
            // Obtener fechas de los parámetros de URL
            const urlParams = new URLSearchParams(window.location.search);
            const fechaInicio = urlParams.get('fecha_inicio');
            const fechaFin = urlParams.get('fecha_fin');
            
            if (fechaInicio && fechaFin) {
                titulo += ` (${fechaInicio} al ${fechaFin})`;
            }
            
            // Actualizar títulos de los gráficos
            chartNivel.setTitle({ text: `Retiros por Nivel Educativo - ${titulo}` });
            chartCurso.setTitle({ text: `Retiros por Curso - ${titulo}` });
            chartMotivos.setTitle({ text: `Motivos de Retiro - ${titulo}` });
        }
        
        // Inicializar gráficos
        let chartNivel, chartCurso, chartMotivos;
        
        // Función para crear el gráfico por nivel
        function crearGraficoNivel() {
            chartNivel = Highcharts.chart('grafico-nivel', {
                chart: {
                    type: 'column'
                },
                title: {
                    text: 'Retiros por Nivel Educativo'
                },
                xAxis: {
                    categories: ['Pre-Básica', 'Básica', 'Media'],
                    crosshair: true,
                    title: {
                        text: 'Nivel Educativo'
                    }
                },
                yAxis: {
                    min: 0,
                    title: {
                        text: 'Cantidad de Retiros'
                    }
                },
                tooltip: {
                    headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                    pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                        '<td style="padding:0"><b>{point.y}</b></td></tr>',
                    footerFormat: '</table>',
                    shared: true,
                    useHTML: true
                },
                plotOptions: {
                    column: {
                        pointPadding: 0.2,
                        borderWidth: 0,
                        dataLabels: {
                            enabled: true,
                            format: '{point.y}'
                        },
                        colorByPoint: true
                    }
                },
                series: [{
                    name: 'Retiros',
                    data: [0, 0, 0], // Datos iniciales vacíos
                    showInLegend: false
                }],
                colors: ['#4285F4', '#34A853', '#FBBC05'],
                exporting: {
                    enabled: false
                }
            });
            
            return chartNivel;
        }
        
        // Función para crear el gráfico por curso
        function crearGraficoCurso() {
            chartCurso = Highcharts.chart('grafico-curso', {
                chart: {
                    type: 'bar'
                },
                title: {
                    text: 'Retiros por Curso'
                },
                xAxis: {
                    categories: [], // Se llenará dinámicamente
                    title: {
                        text: 'Curso'
                    }
                },
                yAxis: {
                    min: 0,
                    title: {
                        text: 'Cantidad de Retiros'
                    }
                },
                tooltip: {
                    headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                    pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                        '<td style="padding:0"><b>{point.y}</b></td></tr>',
                    footerFormat: '</table>',
                    shared: true,
                    useHTML: true
                },
                plotOptions: {
                    bar: {
                        dataLabels: {
                            enabled: true
                        },
                        colorByPoint: true
                    }
                },
                series: [{
                    name: 'Retiros',
                    data: [], // Se llenará dinámicamente
                    showInLegend: false
                }],
                exporting: {
                    enabled: false
                }
            });
            
            return chartCurso;
        }
        
        // Función para crear el gráfico de motivos
        function crearGraficoMotivos() {
            chartMotivos = Highcharts.chart('grafico-motivos', {
                chart: {
                    type: 'pie'
                },
                title: {
                    text: 'Motivos de Retiro'
                },
                tooltip: {
                    pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
                },
                accessibility: {
                    point: {
                        valueSuffix: '%'
                    }
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: true,
                            format: '<b>{point.name}</b>: {point.percentage:.1f} %'
                        }
                    }
                },
                series: [{
                    name: 'Motivos',
                    colorByPoint: true,
                    data: [] // Se llenará dinámicamente
                }],
                exporting: {
                    enabled: false
                }
            });
            
            return chartMotivos;
        }


        // Función para actualizar el gráfico por curso
        function actualizarGraficoCurso(datos) {
            // Verificar que datos sea un objeto válido
            if (!datos || typeof datos !== 'object') {
                console.error('Error: datos no válidos para el gráfico de cursos', datos);
                return;
            }
            
            // Obtener las categorías (nombres de cursos) y sus valores
            const categorias = Object.keys(datos);
            const valores = categorias.map(curso => datos[curso]);
            
            // Verificar que tengamos datos para mostrar
            if (categorias.length === 0) {
                console.warn('No hay cursos para mostrar en el gráfico');
                // Mostrar un mensaje en el gráfico
                chartCurso.update({
                    xAxis: {
                        categories: ['No hay datos']
                    },
                    series: [{
                        name: 'Retiros',
                        data: [0],
                        showInLegend: false
                    }]
                }, true, true);
                return;
            }
            
            // Actualizar el gráfico con los datos
            try {
                chartCurso.update({
                    xAxis: {
                        categories: categorias
                    },
                    series: [{
                        name: 'Retiros',
                        data: valores,
                        showInLegend: false
                    }]
                }, true, true);
            } catch (error) {
                console.error('Error al actualizar el gráfico de cursos:', error);
            }
        }
        
        // Función para actualizar el gráfico por nivel
        function actualizarGraficoNivel(datos) {
            console.log('Actualizando gráfico de nivel con datos:', datos);
            
            const series = [{
                name: 'Retiros',
                data: [
                    datos['Pre-Básica'] || 0,
                    datos['Básica'] || 0,
                    datos['Media'] || 0
                ],
                showInLegend: false
            }];
            
            chartNivel.update({
                series: series
            }, true, true);
        }
        
        // Función para actualizar el gráfico por curso
        function actualizarGraficoCurso(datos) {
            const categorias = Object.keys(datos);
            const valores = categorias.map(curso => datos[curso]);
            
            chartCurso.update({
                xAxis: {
                    categories: categorias
                },
                series: [{
                    name: 'Retiros',
                    data: valores,
                    showInLegend: false
                }]
            }, true, true);
        }
        
        // Función para actualizar el gráfico de motivos
        function actualizarGraficoMotivos(datos) {
            const seriesData = Object.keys(datos).map(motivo => ({
                name: motivo,
                y: datos[motivo]
            }));
            
            chartMotivos.update({
                series: [{
                    name: 'Motivos',
                    colorByPoint: true,
                    data: seriesData
                }]
            }, true, true);
        }
        
        // Crear los gráficos iniciales
        chartNivel = crearGraficoNivel();
        chartCurso = crearGraficoCurso();
        chartMotivos = crearGraficoMotivos();
        
        // Inicializar con todos los datos
        actualizarGraficos(cursos);
        
        // Generar reporte PDF
        document.getElementById('generar-reporte').addEventListener('click', function() {
            // Mostrar indicador de carga
            Swal.fire({
                title: 'Generando PDF',
                html: 'Por favor espere mientras se genera el reporte...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Obtener los contenedores de los gráficos
            const graficoNivel = document.getElementById('grafico-nivel');
            const graficoCurso = document.getElementById('grafico-curso');
            const graficoMotivos = document.getElementById('grafico-motivos');
            
            // Crear un nuevo documento PDF
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 10; // margen en mm

            
            // Cargar imagen del logo
            const logo = new Image();
            logo.src = "{% static 'images/logo_ccl.png' %}";
            
            logo.onload = function() {
                // Función para agregar encabezado a cada página
                function agregarEncabezado(pdf) {
                    // Logo
                    pdf.addImage(logo, 'PNG', margin, margin, 20, 20);
                    
                    // Título principal
                    pdf.setFontSize(16);
                    pdf.setTextColor(40, 40, 40);
                    pdf.text('Colegio Concepción Linares', 35, 15);
                    
                    // Subtítulo
                    pdf.setFontSize(12);
                    pdf.text('Reporte de Retiros de Estudiantes', 35, 22);
                    
                    // Fecha (alineada a la derecha)
                    const fecha = new Date().toLocaleDateString();
                    pdf.setFontSize(10);
                    pdf.text(`Fecha: ${fecha}`, pageWidth - 40, 15);
                    
                    return 40; // Altura del encabezado
                }
                
                // Función para agregar pie de página
                function agregarPiePagina(pdf) {
                    pdf.setFontSize(10);
                    pdf.setTextColor(100);
                    pdf.text("Sistema de Permisos - Colegio Concepción Linares", margin, pageHeight - 10);
                    pdf.text("Contacto: contacto@colegioconcepcionlinares.cl", pageWidth - 90, pageHeight - 10);
                }
                
                // Agregar encabezado a la primera página
                let yPos = agregarEncabezado(pdf);
                
                // Función para agregar un gráfico al PDF
                function agregarGrafico(canvas, titulo, callback) {
                    const imgData = canvas.toDataURL('image/png');
                    const imgProps = pdf.getImageProperties(imgData);
                    const pdfWidth = pageWidth - (margin * 2);
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    
                    // Verificar si hay espacio suficiente en la página actual
                    if (yPos + pdfHeight + 10 > pageHeight - 20) {
                        // No hay espacio, agregar nueva página
                        pdf.addPage();
                        yPos = agregarEncabezado(pdf);
                        yPos +=10;
                    }
                    
                    // Agregar título del gráfico
                    pdf.setFontSize(14);
                    pdf.setTextColor(60, 60, 60);
                    pdf.text(titulo, margin, yPos);
                    yPos += 8;
                    
                    // Agregar el gráfico
                    pdf.addImage(imgData, 'PNG', margin, yPos, pdfWidth, pdfHeight);
                    yPos += pdfHeight + 15; // Espacio después del gráfico
                    
                    // Llamar al callback cuando termine
                    callback();
                }
                
                // Capturar y agregar los gráficos secuencialmente
                html2canvas(graficoNivel).then(function(canvasNivel) {
                    agregarGrafico(canvasNivel, "Retiros por Nivel Educativo", function() {
                        html2canvas(graficoCurso).then(function(canvasCurso) {
                            agregarGrafico(canvasCurso, "Retiros por Curso", function() {
                                html2canvas(graficoMotivos).then(function(canvasMotivos) {
                                    agregarGrafico(canvasMotivos, "Motivos de Retiro", function() {
                                        // Agregar pie de página a todas las páginas
                                        const totalPages = pdf.internal.getNumberOfPages();
                                        for (let i = 1; i <= totalPages; i++) {
                                            pdf.setPage(i);
                                            agregarPiePagina(pdf);
                                        }
                                        
                                        // Guardar el PDF
                                        pdf.save('reporte_retiros_estudiantes.pdf');
                                        
                                        // Cerrar el indicador de carga
                                        Swal.close();
                                    });
                                });
                            });
                        });
                    });
                }).catch(function(error) {
                    console.error('Error al generar el PDF:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Ocurrió un error al generar el PDF. Por favor intente nuevamente.'
                    });
                });
            };
        });
        
        // Verificar si hay parámetros de URL para aplicar filtros automáticamente
        function aplicarFiltrosURL() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Aplicar filtro de fecha si existe en la URL
            const fechaInicio = urlParams.get('fecha_inicio');
            const fechaFin = urlParams.get('fecha_fin');
            
            if (fechaInicio) {
                document.getElementById('fecha-inicio').value = fechaInicio;
            }
            
            if (fechaFin) {
                document.getElementById('fecha-fin').value = fechaFin;
            }
            
            // Aplicar filtro de cursos si existe en la URL
            const cursosFiltro = urlParams.get('cursos');
            if (cursosFiltro) {
                const cursosFiltrados = cursosFiltro.split(',');
                
                // Desactivar todos los cursos primero
                document.querySelectorAll('.curso-btn').forEach(btn => {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-outline-primary');
                });
                
                // Activar solo los cursos filtrados
                cursosFiltrados.forEach(curso => {
                    const btn = document.querySelector(`.curso-btn[data-curso="${curso}"]`);
                    if (btn) {
                        btn.classList.remove('btn-outline-primary');
                        btn.classList.add('btn-primary');
                    }
                });
                
                // Actualizar gráficos con los cursos filtrados
                actualizarGraficos(cursosFiltrados);
            }
        }
        
        // Aplicar filtros de URL al cargar la página
        aplicarFiltrosURL();
    });
</script>

{% endblock %}
