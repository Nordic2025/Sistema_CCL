{% load static%}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css'%}">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link rel="stylesheet" href="{% static 'css/sweetalert2.min.css' %}">
    <link rel="icon" href="{% static 'images/favicon.ico' %}">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'js/sweetalert2.all.min.js' %}"></script>
    <script src="{% static 'js/script.js' %}"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>    
    <script src="{% static 'js/highcharts.js' %}"></script>
    <script src="{% static 'js/exporting.js' %}"></script>
    <script src="{% static 'js/html2canvas.min.js' %}"></script>
    <script src="{% static 'js/jspdf.umd.min.js' %}"></script>
    <!-- Incluir Toastr CSS -->
    <link rel="stylesheet" href="{% static 'css/toastr.min.css' %}">
    
    <!-- Incluir Toastr JS -->
    <script src="{% static 'js/toastr.min.js' %}"></script>

    <title>{% block title %} {% endblock %}</title>

    <style>
      
        .menu_icono {
            width: 1.25rem !important;
            height: 1.25rem !important;
            margin-right: 0.75rem !important;
        }


        /* Para iconos en el sidebar colapsado */
        .sidebar.collapsed .menu-link i, 
        .sidebar.collapsed .dropdown-btn i:first-child,
        .sidebar.collapsed .menu_icono {
            margin-right: 0 !important;
        }


        /* Para iconos en submenús */
        .submenu-link i,
        .submenu-link .menu_icono {
            font-size: 1rem !important;
            width: 1.25rem !important;
            height: 1.25rem !important;
        }

        

    </style>
</head>

<body>

    <!-- Sidebar -->
    <aside class="sidebar collapsed" id="sidebar" onclick="cerrarMenu()">
        <!-- Encabezado del sidebar -->
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <img src="{% static 'images/logo_ccl.png' %}" alt="Logo Colegio Concepcion">
                <span>Colegio Concepción</span>
            </div>
            <button class="sidebar-toggle" id="sidebarToggle">
                <i class='bx bx-chevron-left'></i>
            </button>
        </div>

        <!-- Menú de navegación -->
        <ul class="sidebar-menu">
            <!-- Inicio -->
            <li class="menu-item" data-tooltip="Inicio">
                <a href="{% url 'Modulo_admin:inicio' %}" class="menu-link">
                    <img src="{% static 'icon/hogar.svg' %}" alt="Inicio" class="menu_icono">
                    <span>Inicio</span>
                </a>
            </li>

            <!-- Funcionarios -->
            <li class="menu-item" data-tooltip="Funcionarios">
                <button class="dropdown-btn" id="funcionariosDropdown">
                    <img src="{% static 'icon/usuarios.svg' %}" alt="Inicio" class="menu_icono" style="color: white;">
                    <span>Funcionarios</span>
                    <i class='bx bx-chevron-down'></i>
                </button>
                <ul class="submenu" id="funcionariosSubmenu">
                    <li>
                        <a href="{% url 'Modulo_admin:grafico' %}" class="submenu-link mt-1">
                            Grafico
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'Modulo_admin:historial_permisos' %}" class="submenu-link mt-1">
                            Permisos Completados
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'Modulo_admin:historial_salidas' %}" class="submenu-link mt-1">
                            Salidas Activas
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'Modulo_admin:administradores' %}" class="submenu-link mt-1">
                            Administradores
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'Modulo_admin:area' %}" class="submenu-link mt-1">
                            Área
                        </a>
                    </li>
                </ul>
            </li>

            <!-- Alumnos -->
            <li class="menu-item" data-tooltip="Alumnos">
                <button class="dropdown-btn" id="alumnosDropdown">
                    <img src="{% static 'icon/alumnos.svg' %}" alt="Inicio" class="menu_icono" style="color: white;">
                    <span>Alumnos</span>
                    <i class='bx bx-chevron-down'></i>
                </button>
                <ul class="submenu" id="alumnosSubmenu">
                    <li>
                        <a href="{% url 'Modulo_admin:grafico_alumnos' %}" class="submenu-link mt-1 ">
                            Gráficos
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'Modulo_admin:retiros' %}" class="submenu-link mt-1">
                            Retiros
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'Modulo_admin:justificaciones' %}" class="submenu-link mt-1">
                            Justificativos
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'Modulo_admin:alumnos' %}" class="submenu-link mt-1">
                            Alumnos
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'Modulo_admin:alumnos_egresados' %}" class="submenu-link mt-1">
                            Egresados
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'Modulo_admin:cursos'%}" class="submenu-link mt-1">
                            Cursos
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'Modulo_admin:inspectores'%}" class="submenu-link mt-1">
                            Inspectores
                        </a>
                    </li>
                </ul>
            </li>
        </ul>

        <!-- Perfil de usuario -->
        <div class="user-profile" id="userProfile" onclick="toogleProfileMenu()"> 
            <div class="user-avatar">
                {{ user.first_name|slice:":1" }}{{ user.last_name|slice:":1" }}
            </div>
            <div class="user-info">
                <div class="user-name">{{ user.first_name }} {{ user.last_name }}</div>
                <div class="user-email">{{ user.email }}</div>
            </div>
            <form method="POST" action="{% url 'Modulo_admin:logout_admin' %}">
                {% csrf_token %}
                <button type="submit" class="logout-btn">
                    <i class='bx bx-log-out'></i>
                </button>
            </form>
        </div>
    </aside>

    <div class="main-wrapper">
        <header class="main-header">
            <h1 class="page-title">Ingresos Colegio Concepción</h1>
        </header>

        <main class="main-body ">
            {% block content %}{% endblock %}
        </main>

        <footer class="main-footer">
            Copyright © Colegio Concepción - Linares 2025
        </footer>
    </div>

    {% if messages %}
        {% for message in messages %}
            <script>
                mensaje('{{ message.tags }}', '{{ message }}');
            </script>
        {% endfor %}
    {% endif %}


    <script>
        document.addEventListener('DOMContentLoaded', function() {

            // Referencias a elementos
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const mobileToggle = document.getElementById('mobileToggle');
            const funcionariosDropdown = document.getElementById('funcionariosDropdown');
            const alumnosDropdown = document.getElementById('alumnosDropdown');
            const funcionariosSubmenu = document.getElementById('funcionariosSubmenu');
            const alumnosSubmenu = document.getElementById('alumnosSubmenu');


            // Alternar sidebar colapsado
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('collapsed');
                // Cerrar submenús al colapsar
                funcionariosSubmenu.classList.remove('show');
                alumnosSubmenu.classList.remove('show');
                funcionariosDropdown.classList.remove('active');
                alumnosDropdown.classList.remove('active');
            });
            

            // Alternar submenús
            funcionariosDropdown.addEventListener('click', function(e) {
                e.preventDefault();
                // Si el sidebar está colapsado, expandirlo primero
                if (sidebar.classList.contains('collapsed')) {
                    sidebar.classList.remove('collapsed');
                    setTimeout(() => {
                        toggleSubmenu(funcionariosDropdown, funcionariosSubmenu);
                    }, 300);
                } else {
                    toggleSubmenu(funcionariosDropdown, funcionariosSubmenu);
                    // Cerrar el otro submenú
                    alumnosSubmenu.classList.remove('show');
                    alumnosDropdown.classList.remove('active');
                }
            });
            
            alumnosDropdown.addEventListener('click', function(e) {
                e.preventDefault();
                // Si el sidebar está colapsado, expandirlo primero
                if (sidebar.classList.contains('collapsed')) {
                    sidebar.classList.remove('collapsed');
                    setTimeout(() => {
                        toggleSubmenu(alumnosDropdown, alumnosSubmenu);
                    }, 300);
                } else {
                    toggleSubmenu(alumnosDropdown, alumnosSubmenu);
                    // Cerrar el otro submenú
                    funcionariosSubmenu.classList.remove('show');
                    funcionariosDropdown.classList.remove('active');
                }
            });
            
            function toggleSubmenu(button, submenu) {
                button.classList.toggle('active');
                submenu.classList.toggle('show');
            }
            
            // Marcar la página actual como activa 
            const currentPath = window.location.pathname;
            const allLinks = document.querySelectorAll('.menu-link, .submenu-link');
            let activeFound = false;
            
            allLinks.forEach(link => {
                const href = link.getAttribute('href');
                if (href && currentPath.includes(href) && href !== '#') {
                    // No marcar como activo si es la página de inicio y estamos en otra página
                    if (href.includes('inicio') && currentPath !== href && !currentPath.endsWith('/')) {
                        return;
                    }
                    
                    link.classList.add('active');
                    activeFound = true;
                    
                    // Si es un enlace de submenú, mostrar el submenú y marcar el dropdown
                    if (link.classList.contains('submenu-link')) {
                        const submenu = link.closest('.submenu');
                        const dropdown = submenu.previousElementSibling;
                        
                        submenu.classList.add('show');
                        dropdown.classList.add('active');
                    }
                }
            });


            
            // Solo marcar inicio como activo si estamos exactamente en esa página o en la raíz
            if (!activeFound && (currentPath.endsWith('/inicio/') || currentPath === '/')) {
                const homeLink = document.querySelector('.menu-link[href*="inicio"]');
                if (homeLink) {
                    homeLink.classList.add('active');
                }
            }
            
            // Responsive: ajustar sidebar en pantallas pequeñas
            function checkScreenSize() {
                if (window.innerWidth <= 992) {
                    sidebar.classList.remove('collapsed');
                    sidebar.classList.remove('open');
                }
            }

            // Verificar tamaño de pantalla al cargar y al redimensionar
            checkScreenSize();
            window.addEventListener('resize', checkScreenSize);
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Seleccionar todos los formularios en la página
            const forms = document.querySelectorAll('form');
            
            forms.forEach(form => {
                // Almacenar el estado original de los botones para cada formulario
                const submitButtons = form.querySelectorAll('button[type="submit"], input[type="submit"]');
                
                // Guardar el estado original de cada botón como atributos de datos
                submitButtons.forEach(button => {
                    if (button.tagName === 'BUTTON') {
                        button.setAttribute('data-original-html', button.innerHTML);
                    } else {
                        button.setAttribute('data-original-value', button.value);
                    }
                });
                
                // Función para restaurar los botones a su estado original
                function restoreButtons() {
                    submitButtons.forEach(button => {
                        if (button.tagName === 'BUTTON') {
                            button.innerHTML = button.getAttribute('data-original-html');
                        } else {
                            button.value = button.getAttribute('data-original-value');
                        }
                        button.disabled = false;
                    });
                }
                
                // Función para deshabilitar los botones
                function disableButtons() {
                    submitButtons.forEach(button => {
                        if (button.tagName === 'BUTTON') {
                            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Procesando...';
                        } else {
                            button.value = 'Procesando...';
                        }
                        button.disabled = true;
                    });
                }
                
                // Agregar evento para cuando el formulario se envía
                form.addEventListener('submit', function(e) {
                    // Verificar si el formulario es válido
                    if (this.checkValidity()) {
                        disableButtons();
                    } else {
                        // Si no es válido, asegurarse de que los botones estén habilitados
                        restoreButtons();
                        
                        // Programar una restauración adicional después de un breve retraso
                        // para manejar casos donde la validación ocurre después del evento submit
                        setTimeout(restoreButtons, 100);
                    }
                });
                
                // Agregar evento para cuando hay errores de validación en cualquier campo
                form.querySelectorAll('input, select, textarea').forEach(field => {
                    field.addEventListener('invalid', function() {
                        // Restaurar botones cuando hay error de validación
                        setTimeout(restoreButtons, 10);
                    });
                });
                
                // Agregar evento para detectar cambios en los campos después de un error
                form.addEventListener('input', function() {
                    // Si hay algún campo con clase de error, restaurar los botones
                    if (form.querySelector('.is-invalid, .invalid-feedback, .errorlist')) {
                        restoreButtons();
                    }
                });
            });
            
            // Verificar si hay errores de validación del servidor (Django) al cargar la página
            function checkServerErrors() {
                document.querySelectorAll('form').forEach(form => {
                    if (form.querySelector('.is-invalid, .invalid-feedback, .errorlist, .error')) {
                        // Restaurar los botones del formulario que contiene errores
                        const submitButtons = form.querySelectorAll('button[type="submit"], input[type="submit"]');
                        submitButtons.forEach(button => {
                            button.disabled = false;
                            if (button.tagName === 'BUTTON') {
                                // Intentar restaurar desde el atributo data
                                if (button.hasAttribute('data-original-html')) {
                                    button.innerHTML = button.getAttribute('data-original-html');
                                } 
                                // Si no hay atributo data, usar un valor predeterminado
                                else if (button.innerHTML.includes('Procesando')) {
                                    button.innerHTML = 'Enviar';
                                }
                            } else if (button.tagName === 'INPUT') {
                                if (button.hasAttribute('data-original-value')) {
                                    button.value = button.getAttribute('data-original-value');
                                } else if (button.value === 'Procesando...') {
                                    button.value = 'Enviar';
                                }
                            }
                        });
                    }
                });
            }
            
            // Ejecutar la verificación de errores del servidor al cargar la página
            checkServerErrors();
            
            // También ejecutar después de un breve retraso para asegurar que todos los elementos estén procesados
            setTimeout(checkServerErrors, 500);
        });
    </script>
    
</body>
</html>
